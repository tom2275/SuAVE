var Lawnchair=function(n,t){var r,e,u,i,f;if(!(this instanceof Lawnchair))return new Lawnchair(n,t);if(!JSON)throw"JSON unavailable! Include http://www.json.org/json2.js to fix.";if(arguments.length<=2)t=typeof arguments[0]=="function"?arguments[0]:arguments[1],n=typeof arguments[0]=="function"?{}:arguments[0]||{};else throw"Incorrect # of ctor args!";if(this.record=n.record||"record",this.name=n.name||"records",n.adapter)for(typeof n.adapter=="string"&&(n.adapter=[n.adapter]),u=0,e=n.adapter.length;u<e;u++){for(i=Lawnchair.adapters.length-1;i>=0;i--)if(Lawnchair.adapters[i].adapter===n.adapter[u]&&(r=Lawnchair.adapters[i].valid()?Lawnchair.adapters[i]:undefined,r))break;if(r)break}else for(i=0,f=Lawnchair.adapters.length;i<f;i++)if(r=Lawnchair.adapters[i].valid()?Lawnchair.adapters[i]:undefined,r)break;if(!r)throw"No valid adapter.";for(u in r)this[u]=r[u];for(i=0,f=Lawnchair.plugins.length;i<f;i++)Lawnchair.plugins[i].call(this);this.init(n,t)};Lawnchair.adapters=[];Lawnchair.adapter=function(n,t){var r,u,i;t.adapter=n;r="adapter valid init keys save batch get exists all remove nuke".split(" ");u=this.prototype.indexOf;for(i in t)if(u(r,i)===-1)throw"Invalid adapter! Nonstandard method: "+i;Lawnchair.adapters.splice(0,0,t)};Lawnchair.plugins=[];Lawnchair.plugin=function(n){for(var t in n)t==="init"?Lawnchair.plugins.push(n[t]):this.prototype[t]=n[t]};Lawnchair.prototype={isArray:Array.isArray||function(n){return Object.prototype.toString.call(n)==="[object Array]"},indexOf:function(n,t,i,r){if(n.indexOf)return n.indexOf(t);for(i=0,r=n.length;i<r;i++)if(n[i]===t)return i;return-1},lambda:function(n){return this.fn(this.record,n)},fn:function(n,t){return typeof t=="string"?new Function(n,t):t},uuid:function(){var n=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()},each:function(n){var i=this.lambda(n),t,r;if(this.__results)for(t=0,r=this.__results.length;t<r;t++)i.call(this,this.__results[t],t);else this.all(function(n){for(var t=0,r=n.length;t<r;t++)i.call(this,n[t],t)});return this}};typeof module!="undefined"&&module.exports&&(module.exports=Lawnchair);Lawnchair.adapter("window-name",function(){typeof window=="undefined"&&(window={top:{}});var n={};try{n=JSON.parse(window.top.name)}catch(t){}return{valid:function(){return typeof window.top.name!="undefined"},init:function(t,i){return n[this.name]=n[this.name]||{index:[],store:{}},this.index=n[this.name].index,this.store=n[this.name].store,this.fn(this.name,i).call(this,this),this},keys:function(n){return this.fn("keys",n).call(this,this.index),this},save:function(t,i){var r=t.key||this.uuid();return this.exists(r,function(u){u||(t.key&&delete t.key,this.index.push(r));this.store[r]=t;try{window.top.name=JSON.stringify(n)}catch(f){u||(this.index.pop(),delete this.store[r]);throw f;}i&&(t.key=r,this.lambda(i).call(this,t))}),this},batch:function(n,t){for(var r=[],i=0,u=n.length;i<u;i++)this.save(n[i],function(n){r.push(n)});return t&&this.lambda(t).call(this,r),this},get:function(n,t){var i,r,u;if(this.isArray(n))for(i=[],r=0,u=n.length;r<u;r++)i.push(this.store[n[r]]);else i=this.store[n],i&&(i.key=n);return t&&this.lambda(t).call(this,i),this},exists:function(n,t){return this.lambda(t).call(this,!!this.store[n]),this},all:function(n){for(var i,r=[],t=0,u=this.index.length;t<u;t++)i=this.store[this.index[t]],i.key=this.index[t],r.push(i);return this.fn(this.name,n).call(this,r),this},remove:function(t,i){for(var f,e,u=this.isArray(t)?t:[t],r=0,o=u.length;r<o;r++)(f=u[r].key?u[r].key:u[r],e=this.indexOf(this.index,f),e<0)||(delete this.store[f],this.index.splice(e,1));return window.top.name=JSON.stringify(n),i&&this.lambda(i).call(this),this},nuke:function(t){return this.store=n[this.name].store={},this.index=n[this.name].index=[],window.top.name=JSON.stringify(n),t&&this.lambda(t).call(this),this}}}());Lawnchair.adapter("dom",function(){var n=window.localStorage,t=function(t){return{key:t+"._index_",all:function(){var t=n.getItem(JSON.stringify(this.key));return t&&(t=JSON.parse(t)),t===null&&n.setItem(JSON.stringify(this.key),JSON.stringify([])),JSON.parse(n.getItem(JSON.stringify(this.key)))},add:function(t){var i=this.all();i.push(t);n.setItem(JSON.stringify(this.key),JSON.stringify(i))},del:function(t){for(var r=this.all(),u=[],i=0,f=r.length;i<f;i++)r[i]!=t&&u.push(r[i]);n.setItem(JSON.stringify(this.key),JSON.stringify(u))},find:function(n){for(var i=this.all(),t=0,r=i.length;t<r;t++)if(n===i[t])return t;return!1}}};return{valid:function(){return!!n&&function(){var i=!0,t=Math.random();try{n.setItem(t,t)}catch(r){i=!1}return n.removeItem(t),i}()},init:function(n,i){this.indexer=t(this.name);i&&this.fn(this.name,i).call(this,this)},save:function(t,i){var r=t.key?this.name+"."+t.key:this.name+"."+this.uuid();return delete t.key,n.setItem(r,JSON.stringify(t)),this.indexer.find(r)===!1&&this.indexer.add(r),t.key=r.slice(this.name.length+1),i&&this.lambda(i).call(this,t),this},batch:function(n,t){for(var r=[],i=0,u=n.length;i<u;i++)this.save(n[i],function(n){r.push(n)});return t&&this.lambda(t).call(this,r),this},keys:function(n){var u;if(n){var i=this.name,r=this.indexer.all(),t=[];if(Array.prototype.map)t=r.map(function(n){return n.replace(i+".","")});else for(u in r)t.push(u.replace(i+".",""));this.fn("keys",n).call(this,t)}return this},get:function(t,i){var e,u,o,f,r;if(this.isArray(t)){for(e=[],u=0,o=t.length;u<o;u++)f=this.name+"."+t[u],r=n.getItem(f),r&&(r=JSON.parse(r),r.key=t[u]),e.push(r);i&&this.lambda(i).call(this,e)}else f=this.name+"."+t,r=n.getItem(f),r&&(r=JSON.parse(r),r.key=t),i&&this.lambda(i).call(this,r);return this},exists:function(n,t){var i=this.indexer.find(this.name+"."+n)===!1?!1:!0;return this.lambda(t).call(this,i),this},all:function(t){for(var f=this.indexer.all(),e=[],i,r,u=0,o=f.length;u<o;u++)r=f[u],i=JSON.parse(n.getItem(r)),i.key=r.replace(this.name+".",""),e.push(i);return t&&this.fn(this.name,t).call(this,e),this},remove:function(t,i){var u=this,r,e,o,f;if(this.isArray(t)){for(e=t.length,o=function(n){u.remove(t[n],function(){--e>0||i&&u.lambda(i).call(u)})},r=0;r<t.length;r++)o(r);return this}return f=this.name+"."+(t.key?t.key:t),this.indexer.del(f),n.removeItem(f),i&&this.lambda(i).call(this),this},nuke:function(n){return this.all(function(t){for(var i=0,r=t.length;i<r;i++)this.remove(t[i]);n&&this.lambda(n).call(this)}),this}}}());
