PivotViewer.Models.Loaders.ICollectionLoader=Object.subClass({init:function(){},loadCollection:function(e){if(!e instanceof PivotViewer.Models.Collection)throw"collection not an instance of PivotViewer.Models.Collection."}}),PivotViewer.Models.Loaders.CXMLLoader=PivotViewer.Models.Loaders.ICollectionLoader.subClass({init:function(e,t){this.cxmlUriNoProxy=e,this.cxmlUri=t?t+e:e},loadCollection:function(e){var e=e;this._super(e),e.baseNoProxy=this.cxmlUriNoProxy,e.base=this.cxmlUri;var t=this;this.cxmlUri.endsWith(".zip")?jBinary.loadData(this.cxmlUri).then(function(i){var o=new JSZip;o.load(i);var a=o.file(/.cxml/)[0].asText();t.loadXML(e,$.parseXML(a.substring(a.indexOf(">")+1)))}):$.ajax({type:"GET",url:this.cxmlUri,dataType:"xml",success:function(e){return function(i){t.loadXML(e,i)}}(e),error:function(e,t,i){$(".pv-loading").remove();var o="Error loading CXML Collection<br><br>";o+="URL        : "+this.url+"<br>",o+="Status : "+e.status+" "+i+"<br>",o+="Details    : "+e.responseText+"<br>",o+="<br>SuAVE cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-loading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>SuAVE</h2><p>'+o+"</p></div></div>");setTimeout(function(){window.open("#pv-loading-error","_self")},1e3)}})},loadXML:function(e,t){var i=$(t).find("Collection")[0],o=0,a="P";if(void 0==i){$(".pv-loading").remove();u="Error parsing CXML Collection<br>";throw u+="<br>SuAVE cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-parse-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>SuAVE</h2><p>'+u+"</p></div></div>"),setTimeout(function(){window.open("#pv-parse-error","_self")},1e3),"Error parsing CXML Collection"}for(f=0;f<i.attributes.length;f++)if("http://schemas.microsoft.com/livelabs/pivot/collection/2009"==i.attributes[f].value){a=void 0!=i.attributes[f].localName?i.attributes[f].localName:i.attributes[f].baseName;break}e.name=$(i).attr("Name"),e.brandImage=void 0!=$(i).attr(a+":BrandImage")?$(i).attr(a+":BrandImage"):"";var r=$(t).find("FacetCategory");L=a;for(f=0;f<r.length;f++){for(var l=$(r[f]),n=0;n<l[0].attributes.length;n++)if("http://schemas.microsoft.com/livelabs/pivot/collection/2009"==l[0].attributes[n].value){a=void 0!=l[0].attributes[n].localName?l[0].attributes[n].localName:l[0].attributes[n].baseName;break}var s=new PivotViewer.Models.Category(l.attr("Name"),l.attr("Type"),void 0==l.attr(a+":IsFilterVisible")||"true"==l.attr(a+":IsFilterVisible").toLowerCase()),d=l.find(a+"\\:SortOrder"),c=d.find(a+"\\:SortValue");if(0==d.length&&(c=(d=l.find("SortOrder")).find("SortValue")),1==d.length){for(var v=new PivotViewer.Models.CategorySort(d.attr("Name")),n=0;n<c.length;n++)v.sortValues.push($(c[n]).attr("Value"));s.customSort=v}e.categories.push(s),a=L}var p=$(t).find("Items");if(1==p.length){var h=$(p[0]).find("Item");if(e.imageBase=$(p[0]).attr("ImgBase"),0==h.length){$(".pv-loading").remove();var u="There are no items in the CXML Collection<br><br>";$(".pv-wrapper").append('<div id="pv-empty-collection-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>SuAVE</h2><p>'+u+"</p></div></div>"),setTimeout(function(){window.open("#pv-empty-collection-error","_self")},1e3)}else for(var f=0;f<h.length;f++){var m=new PivotViewer.Models.Item($(h[f]).attr("Img").replace("#",""),$(h[f]).attr("Id"),$(h[f]).attr("Href"),$(h[f]).attr("Name")),g=$(h[f]).find("Description");1==g.length&&g[0].childNodes.length&&(m.description=PivotViewer.Utils.htmlSpecialChars(g[0].childNodes[0].nodeValue));for(var w=$(h[f]).find("Facet"),n=0;n<w.length;n++){for(var V=new PivotViewer.Models.Facet($(w[n]).attr("Name")),b=$(w[n]).children(),C=0;C<b.length;C++)if(1==b[C].nodeType){var N=$.trim($(b[C]).attr("Value"));if(null==N||""==N)if("Link"==b[C].nodeName)if(""==$(b[C]).attr("Href")||null==$(b[C]).attr("Href")){P=new PivotViewer.Models.FacetValue(PivotViewer.Utils.htmlSpecialChars("(empty Link)"));V.addValue(P)}else""==$(b[C]).attr("Name")||null==$(b[C]).attr("Name")?((P=new PivotViewer.Models.FacetValue("(unnamed Link)")).href=$(b[C]).attr("Href"),V.addValue(P)):((P=new PivotViewer.Models.FacetValue($(b[C]).attr("Name"))).href=$(b[C]).attr("Href"),V.addValue(P));else{var P=new PivotViewer.Models.FacetValue(PivotViewer.Utils.htmlSpecialChars("(empty "+b[C].nodeName+")"));V.addValue(P)}else"Number"==b[C].nodeName?V.addValue(new PivotViewer.Models.FacetValue(parseFloat(N))):V.addValue(new PivotViewer.Models.FacetValue(PivotViewer.Utils.htmlSpecialChars(N)))}m.facets.push(V)}var M=$(h[f]).find("Extension");if(1==M.length){for(var L=a,n=0;n<M[0].childNodes.length&&!(a=M[0].childNodes[n].lookupPrefix("http://schemas.microsoft.com/livelabs/pivot/collection/2009"));n++);var y=$(M[0]).find(a+"\\:Related, Related");if(1==y.length){for(var S=$(y[0]).find(a+"\\:Link, Link"),I=0;I<S.length;I++){var k=$(S[I]).attr("Name"),F=$(S[I]).attr("Href");if(-1==F.indexOf(".cxml")&&F.indexOf("pivot.vsp")>=0)F=(U=$.url(this.url)).attr("protocol")+"://"+U.attr("authority")+U.attr("directory")+F;else if(-1==F.indexOf(".cxml")&&F.indexOf("sparql")>=0){var U=$.url(this.url);F=location.origin+location.pathname+"?url="+F}var X=new PivotViewer.Models.ItemLink(k,F);m.links.push(X)}S.length>o&&(o=S.length)}a=L}e.items.push(m)}}e.maxRelatedLinks=o;var E=$(t).find("Extension");if(E.length>1)for(x=0;x<E.length;x++){for(var L=a,n=0;n<E[x].childNodes.length&&!(a=E[0].childNodes[n].lookupPrefix("http://schemas.microsoft.com/livelabs/pivot/collection/2009"));n++);var T=$(E[x]).find(a+"\\:Copyright, Copyright");if(T.length>0){e.copyrightName=$(T[0]).attr("Name"),e.copyrightHref=$(T[0]).attr("Href");break}a=L}h.length>0&&$.publish("/PivotViewer/Models/Collection/Loaded",null)},loadColumn:function(e){},getRow:function(e){return PivotCollection.getItemById(e).facets}});