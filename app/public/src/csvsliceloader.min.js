PivotViewer.Models.Loaders.CSVSliceLoader=PivotViewer.Models.Loaders.CSVLoader.subClass({init:function(e,t){this._super(e),this.sliceSize=t},LoadCollection:function(e){this.collection=e,e.CollectionBaseNoProxy=this.CSVUriNoProxy,e.CollectionBase=this.CSVUri;var t=e.CollectionBase,i=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));e.CollectionName=i,e.ImageBase=i+"/"+i+".dzc",e.BrandImage="";var o=this;this.data=[],this.slicesLoaded=[],this.currentColSlice=0,this.currentRowSlice=-1,this.rowSlices=[],this.lock=!1,this.loading=!0,$.ajax({type:"GET",url:"projects/"+i+".axis1.csv",dataType:"text",success:function(e){o.axis1=e.csvToArray(),$.ajax({type:"GET",url:"projects/"+i+".axis2.csv",dataType:"text",success:function(e){o.axis2=e.csvToArray(),o.LoadData()}})}})},LoadData:function(){for(var e,t,i=0;i<this.axis1[0].length;i++){-1!==(e=this.axis1[0][i].indexOf("#"))?t=-1!==this.axis1[0][i].indexOf("#number",e)?PivotViewer.Models.FacetType.Number:-1!==this.axis1[0][i].indexOf("#date",e)?PivotViewer.Models.FacetType.DateTime:-1!==this.axis1[0][i].indexOf("#ordinal",e)?PivotViewer.Models.FacetType.Ordinal:PivotViewer.Models.FacetType.String:(t=PivotViewer.Models.FacetType.String,e=this.axis1[0][i].length);var o=new PivotViewer.Models.FacetCategory(this.axis1[0][i].substring(0,e),null,t,!0,!0,!0);o.column=i,this.collection.FacetCategories.push(o)}for(i=1;i<this.axis2.length;i++){var a=this.axis2[i],s=new PivotViewer.Models.Item(a[0],String(i),"",a[1]);this.collection.Items.push(s)}this.numSlices=Math.ceil(this.axis1[0].length/this.sliceSize),this.sliceThread=setInterval(this.LoadSlice,200,this),$.publish("/PivotViewer/Models/Collection/Loaded",null)},LoadSlice:function(e){if(!e.lock)if(null!=e.mustLoad)e.lock=!0,LoadSem.acquire(function(t){$.ajax({type:"GET",url:"projects/"+e.collection.CollectionName+("COL"==e.mustLoad.type?".col":".row")+e.mustLoad.slice+".csv",dataType:"text",success:function(i){var o=i.csvToArray();if("COL"==e.mustLoad.type)for(var a=0,s=e.mustLoad.slice*e.sliceSize;a<o.length&&s<e.collection.FacetCategories.length;a++,s++)e.data[s]=o[a],e.slicesLoaded[s]=!0;else e.rowSlices=o,e.currentRowSlice=e.mustLoadSlice.slice;e.mustLoad=null,e.lock=!1,t()}})});else{if(e.currentColSlice==e.numSlices)return window.clearInterval(e.sliceThread),void(e.loading=!1);e.lock=!0;var e=e;$.ajax({type:"GET",url:"projects/"+e.collection.CollectionName+".col"+e.currentColSlice+".csv",datatype:"text",success:function(t){for(var i=t.csvToArray(),o=0,a=e.currentColSlice*e.sliceSize;o<i.length&&a<e.collection.FacetCategories.length;o++,a++)e.data[a]=i[o],e.slicesLoaded[a]=!0;e.currentColSlice++,e.lock=!1}})}},RequestRow:function(e){this.mustLoad={slice:Math.floor(e/this.sliceSize),type:"ROW"},this.LoadSlice(this)},RequestColumn:function(e){var t=Math.floor(e/this.sliceSize);this.slicesLoaded[t]||(this.mustLoad={slice:t,type:"COL"},this.LoadSlice(this))},LoadColumn:function(e){this.slicesLoaded[e.column]||this.RequestColumn(e.column);var t=this;LoadSem.acquire(function(i){for(var o=0;o<t.collection.Items.length;o++){var a=t.collection.Items[o],s=t.data[e.column][o];if(""!=s.trim()){var l=new PivotViewer.Models.Facet(e.Name);e.Type==PivotViewer.Models.FacetType.String?l.AddFacetValue(new PivotViewer.Models.FacetValue(s)):e.Type==PivotViewer.Models.FacetType.Number||e.Type==PivotViewer.Models.FacetType.Ordinal?l.AddFacetValue(new PivotViewer.Models.FacetValue(parseFloat(s.replace(/,/g,"").match(/(?:-?\d+\.?\d*)|(?:-?\d*\.?\d+)/)[0]),s)):e.Type==PivotViewer.Models.FacetType.DateTime&&l.AddFacetValue(new PivotViewer.Models.FacetValue(moment(s,moment.parseFormat(s))._d.toString(),s)),a.Facets.push(l)}}i()})},GetRow:function(e){var t,i,o=[];this.loading?(Math.floor(e/this.sliceSize)!=this.currentRowSlice&&this.RequestRow(e),t=e%sliceSize,i=this.rowSlices):(t=e,i=this.data);var a=this;return LoadSem.acquire(function(e){for(var s=0;s<a.collection.FacetCategories.length;s++){var l=a.collection.FacetCategories[s],c=i[s][t];if(""!=c.trim()){var r=new PivotViewer.Models.Facet(l.Name);l.Type==PivotViewer.Models.FacetType.String?r.AddFacetValue(new PivotViewer.Models.FacetValue(c)):l.Type==PivotViewer.Models.FacetType.Number||l.Type==PivotViewer.Models.FacetType.Ordinal?r.AddFacetValue(new PivotViewer.Models.FacetValue(parseFloat(c.replace(/,/g,"").match(/(?:-?\d+\.?\d*)|(?:-?\d*\.?\d+)/)[0]),c)):l.Type==PivotViewer.Models.FacetType.DateTime&&r.AddFacetValue(new PivotViewer.Models.FacetValue(moment(c,moment.parseFormat(c))._d.toString(),c)),o.push(r)}}e()}),o}});