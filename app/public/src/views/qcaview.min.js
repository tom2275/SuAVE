PivotViewer.Utils.loadScript("src/views/crosstabview.min.js");PivotViewer.Utils.loadScript("src/views/iv.min.js");PivotViewer.Views.QcaView=PivotViewer.Views.CrosstabView.subClass({init:function(){this._super();this.singleEq=!1;var n=this;$.subscribe("/PivotViewer/Views/IVFiltered",function(){n.filtered=!0;n.activate()})},filterY:function(){this.subbucketize()},bucketize:function(n,t,i){var e=IV.getIV(),it,s,r,rt,a,c,p,k,b,d,g,ut,h,v,l,nt,tt,y,f,o,u,i,w;if(e==null)return null;for(it=PivotCollection.getCategoryByName(t),s=[],s.ids=[],s[0]=new PivotViewer.Models.Bucket("","True Positive"),s[1]=new PivotViewer.Models.Bucket("","False Positive"),this.singleEq&&(s[2]=new PivotViewer.Models.Bucket("","True Negative"),s[3]=new PivotViewer.Models.Bucket("","False Negative")),r=0;r<s.length;r++)s[r].colCount=0,s[r].subBuckets=[],s[r].subBuckets.ids=[];if(this.singleEq&&i){for(r=0;r<s.length;r++)s[r].subBuckets[0]=new PivotViewer.Models.Bucket(i.startRange,i.startLabel);for(i.tiles=[],i.ids=[],r=0;r<this.filterList.length;r++)f=this.filterList[r],i.addTile(f),u=i==this.bucketsY[this.bucketsY.ids[f.item.id]]?i.oldBkt.ids[f.item.id]?0:1:i.oldBkt.ids[f.item.id]?3:2,o=s[u],o.addTile(f),o.colCount++,s.ids[f.item.id]=u,o.subBuckets[0].addTile(f),o.subBuckets.ids[f.item.id]=0,this.bucketsY.ids[f.item.id]=0;rt=this.bucketsY.ids;this.bucketsY=[i];this.bucketsY.ids=rt}else{for(a=this._super(n,t),c=[],this.contribd=[],this.contribn=[],r=0;r<a.length;r++)if(a[r].order=r,c[r]=[],this.contribn[r]=[],e.categories.length==0)c[r][1]=0;else for(u=0;u<1<<e.categories.length;u++)c[r][u]=0;for(p=[],r=0;r<n.length;r++)if(f=n[r],k=f.item.getFacetByName(it.name),k!=undefined){if(e.categories.length==0)f.bits=1;else{for(b=0,u=0;u<e.categories.length;u++){if(d=e.categories[u],g=f.item.getFacetByName(d.name),g==undefined)break;ivalue=g.values[0].value;d.isString()?e.values[u][ivalue]&&(b|=1<<u):e.values[u][0]<=ivalue&&e.values[u][1]>=ivalue&&(b|=1<<u)}if(u<e.categories.length)continue;f.bits=b}if(o=a.ids[f.item.id],ut=k.values[0].value,c[o][f.bits]++,e.categories.length==0)this.contribn[o].a++,this.contribd.a++;else for(u=0;u<e.categories.length;u++)h="",u<e.categories.length-1&&(h+=f.bits>>u+1),h+="a",u>0&&(h+=f.bits%(1<<u)),this.contribn[o][h]==undefined&&(this.contribn[o][h]=0,this.contribd[h]==undefined&&(this.contribd[h]=0)),this.contribn[o][h]++,this.contribd[h]++;p.push(f)}if(this.filterList2=this.filterList=p,this.bucketsY=[],this.bucketsY.ids=[],v=[],l=[],e.categories.length==0)l[1]=0;else for(r=0;r<1<<e.categories.length;r++)l[r]=0;for(r=0;r<a.length;r++)if(c[r]!=undefined)if(o=a[r],e.categories.length==0)c[r][1]>l[1]&&(l[1]=c[r][1],v[1]=o);else for(u=0;u<1<<e.categories.length;u++)nt=c[r][u],nt>l[u]&&(l[u]=nt,v[u]=o);for(tt=[],r=0,order=0;r<v.length;r++)v[r]!=undefined&&(y=new PivotViewer.Models.Bucket(null,null),y.oldBkt=v[r],y.order=order++,y.eq=r,this.bucketsY.push(y),tt[r]=y);for(r=0;r<s.length;r++)for(o=s[r],u=0;u<this.bucketsY.length;u++)i=this.bucketsY[u],o.subBuckets[u]=new PivotViewer.Models.Bucket(i.startRange,i.startLabel);for(r=0;r<p.length;r++)f=p[r],i=tt[f.bits],i.addTile(f),this.bucketsY.ids[f.item.id]=i.order,u=i.oldBkt.ids[f.item.id]?0:1,o=s[u],s.ids[f.item.id]=u,o.addTile(f),o.colCount++,o.subBuckets[i.order].addTile(f),o.subBuckets.ids[f.item.id]=i.order;for(r=0;r<this.bucketsY.length;r++){if(i=this.bucketsY[r],w="",e.categories.length==0)w+="\u2205";else for(u=0;u<e.categories.length;u++)w+=(i.eq>>u&1?"":"~")+e.categories[u].ivCode+(u<e.categories.length-1?" ^ ":"");w+="<br>&#8594; "+this.sortCategory+": ("+i.oldBkt.getLabel()+")";i.startLabel=i.endLabel=w}}return s},activate:function(){IV.on();this.filtered&&(this.singleEq=!1);this._super();$("#pv-altsortcontrols").hide()},deactivate:function(){IV.off();this.singleEq=!1;this._super();this.filtered=!0},getViewName:function(){return"QCA View"},getButtonImage: function () {return 'images/QCAView.png';},getButtonImageSelected: function () {return 'images/QCAViewSelected.png';},getStatsBox:function(){return"<div style='position:absolute; width: "+(this.columnWidth-4)+"px; height: 50px; top: "+i*this.rowHeight+"px;'><div style='text-align:center'>Equations<\/div><div style='position:absolute; right:2px;'>Result<\/div><\/div>"},handleHover:function(n){var u,f,l,r,t,i,e,o,c,s,h,a,v;if(this.super_handleHover(n),$(".pv-crosstabview-overlay-bucket").removeClass("bucketview-bucket-hover"),$(".pv-tooltip").remove(),!(this.scale>1)){if(u=this.getBucket(n.x),f=this.getBucketY(n.y),u>=0&&f>=0){$(".pv-crosstabview-overlay-bucket").eq(u*this.bucketsY.length+(this.bucketsY.length-f-1)).addClass("bucketview-bucket-hover");return}if(!(u<-1)&&!(f<-1)){if(u==-1){if(f==-1)return;if(l=$(".pv-bucketview-overlay-buckettitle-left").eq(f),r=this.bucketsY[f],t="Dependent Variable: "+this.sortCategory+"<br>Predicted Values: ",r.oldBkt.values.length>0)for(t+=r.oldBkt.values[0],i=1;i<r.oldBkt.values.length;i++)t+=", "+r.oldBkt.values[i];else t+="from "+r.oldBkt.startLabel+" (inclusive) to "+r.oldBkt.endLabel+" (exclusive)";for(t+="<br><br>Independent Variables:<br>",e=IV.getIV(),i=0;i<e.categories.length;i++){if(o="",i<e.categories.length-1&&(o+=r.eq>>i+1),o+="a",i>0&&(o+=r.eq%(1<<i)),c=this.buckets[0].subBuckets[f].tiles.length/r.tiles.length,c-=e.categories.length>1?this.contribn[r.oldBkt.order][o]/this.contribd[o]:r.oldBkt.tiles.length/this.filterList.length,c=Math.floor(c*100),s=e.categories[i],h=e.values[i],t+=s.ivCode,s.ivCode!="\u2205"){if(t+=". "+s.name+(r.eq>>i&1?" (true)":" (false)")+"<br>Defined True Values: ",s.isNumber()||s.isOrdinal())t+="from "+h[0]+" (inclusive) to "+h[1]+" (exclusive)";else for(t+=h[0],a=1;a<h.length;a++)t+=", "+h[a];t+="<br>Adjusts Prediction Accuracy by: "+c+"%"}else t+=" (No Independent Variables Selected)";i<e.categories.length-1&&(t+="<br><br>")}}else if(f==-1)l=$(".pv-bucketview-overlay-buckettitle").eq(u),u==0?t="Items that match the characteristics described by the independent variables<br>and for which the dependent variable has been correctly predicted.":u==1?t="Items that match the characteristics described by the independent variables<br>but for which the dependent variable has been incorrectly predicted.":u==2?t="Items that do not match the characteristics<br>described by the independent variables<br>and for which the value of the dependent variable<br>correctly does not match the given value.":u==3&&(t="Items that do not match the characteristics<br>described by the independent variables<br>but for which the value of the dependent variables<br>incorrectly does match the given value.");else return;v=l.offset();t="<div class='pv-tooltip'>"+t+"<\/div>";$(".pv-bucketview-overlay").append(t);$(".pv-tooltip").offset(l.offset())}}},handleClick:function(n){var t,i;if(this.hasSubsets()&&!PV.subsets.finalized){PV.subsets.finalized=!0;PV.filterViews();return}t=this.super_handleClick(n);this.selected!=null&&this.selected.setSelected(!1);t!=null?this.selected!=t?(t.setSelected(!0),this.centerOnTile(t),this.setSelected(t),$(".pv-bucketview-overlay div").fadeOut("slow")):(t=null,this.setSelected(null),PV.zoom(0),$(".pv-bucketview-overlay div").fadeIn("slow")):(this.singleEq?(this.singleEq=!1,this.buckets=this.bucketize(this.filterList,this.sortCategory)):(i=this.getBucketY(n.y),i>=0&&(this.singleEq=!0,this.buckets=this.bucketize(this.filterList,this.sortCategory,this.bucketsY[i]))),this.activate());$.publish("/PivotViewer/Views/Item/Selected",[{item:t}])}});
