PivotViewer.Views.TileController=Object.subClass({init:function(t){this._tiles=[],this._tilesById=[],this._easing=new Easing.Easer({type:"circular",side:"both"}),this._imageController=t;var i=this;this._tiles.push=function(t){this.__proto__.push.apply(i._tiles,[t]),i._tilesById[t.item.id]=t},this.isZooming=!1,this._started=!1,this.isFirefox="undefined"!=typeof InstallTrigger},getTileById:function(t){var i=this._tilesById[t];return void 0==i?null:i},initTiles:function(t,i,e){for(var s=0;s<t.length;s++){var h=new PivotViewer.Views.Tile(this._imageController);h.item=t[s],this._canvasContext=e,h.context=this._canvasContext,tileLocation=new PivotViewer.Views.TileLocation,h._locations.push(tileLocation),this._tiles.push(h)}return this._tiles},animateTiles:function(){var t=this;this._started=!0;var i=null,e=this._tiles;if(this._breaks=!1,e.length>0&&null!=e[0].context){i=e[0].context;for(var s=i.canvas.width=$(".pv-canvas").width(),h=i.canvas.height=$(".pv-canvas").height(),a=!1,n=document.createElement("textarea"),o=0;o<e.length;o++){var r=e[o],l=r._locations;for(x=0;x<l.length;x++){var g=l[x],c=PivotViewer.Utils.now()-r.start,d=r.end-r.start;c<=d?(g.x==g.destinationx&&g.y==g.destinationy||(a=!0),g.x=this._easing.ease(c,g.startx,g.destinationx-g.startx,d),g.y=this._easing.ease(c,g.starty,g.destinationy-g.starty,d),r.width==r.destinationWidth&&r.height==r.destinationHeight||(a=!0),r.width=this._easing.ease(c,r.startwidth,r.destinationwidth-r.startwidth,d),r.height=this._easing.ease(c,r.startheight,r.destinationheight-r.startheight,d)):(g.x=g.destinationx,g.y=g.destinationy,r.width=r.destinationwidth,r.height=r.destinationheight)}}}this._isZooming!=a&&(this._isZooming=a,$.publish("/PivotViewer/ImageController/Zoom",[this._isZooming])),i.clearRect(0,0,i.canvas.width,i.canvas.height);var v=new Array(e.length),i=e[0].context;i.font="12px Roboto,Helvetica,Arial,sans-serif";for(var f=0,u=0,w=0,m=0,_=0,s=i.canvas.width,h=i.canvas.height,o=0;o<e.length;o++){var r=e[o],l=r._locations;v[o]=new Array(l.length);for(var x=0;x<l.length;x++){var g=l[x],p=g.x,y=g.y,b=p+r.width,T=y+r.height;if(this.inBox(p,b,y,T,0,s,0,h)||this.inBox(0,s,0,h,p,b,y,T)||this.crossBox([p,b],[T,T],[0,0],[0,h])||this.crossBox([p,b],[y,y],[0,0],[0,h])||this.crossBox([p,b],[T,T],[s,s],[0,h])||this.crossBox([p,b],[y,y],[s,s],[0,h])||this.crossBox([0,s],[0,0],[p,p],[T,y])||this.crossBox([0,s],[h,h],[p,p],[T,y])||this.crossBox([0,s],[0,0],[b,b],[T,y])||this.crossBox([0,s],[h,h],[b,b],[T,y])){if(void 0!=r.item.name){n.innerHTML=r.item.name;var M=i.measureText(n.value);f+=M.width,M.width>w&&(w=M.width),u+=n.value.length,n.value.length>m&&(m=n.value.length)}v[o][x]=r.draw(x),_<r.width&&(_=r.width)}}}if(m>0){var C=_-24,I=Math.floor(C/w*12);I>30&&(I=30);var V=I>=12;if(!V){var B=f/u,E=C+3*B;for(m-=3;m>=20&&!V;m--)I=Math.floor(E/(m*B)*12),V=I>=12}if(V){$.publish("/PivotViewer/ImageController/TooltipEnable",[!1]),i.font=I+"px Roboto,Helvetica,Arial,sans-serif";var L=this.getTextHeight(i.font);I=L.height,text_ascent=L.ascent,text_descent=L.descent;for(var o=0;o<e.length;o++)for(var r=e[o],l=r._locations,x=0;x<l.length;x++){var P=v[o][x];if(void 0!=P&&0!=P.width){g=l[x];var k=P.width,S=P.height,A=P.xmargin,H=P.ymargin;n.innerHTML=r.item.name;var D=n.value,R=[];if(D.length>m){for(var O=D.split(" "),q="",Z=0;Z<O.length;Z++){var F=q.length+O[Z].length;q.length>0&&F++,F>m?(R.push(q),q=O[Z]):q+=" "+O[Z]}R.push(q),R.length>3&&(R=[],R.push(D.substr(0,m-3)+"..."))}else R.push(D);for(var W=0,j=0;j<R.length;j++){var M=i.measureText(R[j]);W<M.width&&(W=M.width)}var z=I,Q=R.length*z,g=l[x],U=g.x+A,G=g.y+H;i.save(),i.strokeStyle="rgb( 0, 0, 0 )",i.fillStyle="rgba( 64, 64, 64, .5 )";var J=W+8,K=Q;hshift=this.isFirefox?4:8,this.roundRect(i,U+(k-J)/2,G+S-(K+hshift),J,K,4,!0,!1),i.restore(),i.save(),i.textBaseline="alphabetic",i.textAlign="center",i.fillStyle="white";for(var j=0;j<R.length;j++)n.innerHTML=R[j],i.fillText(n.value,U+k/2,G-Q+S+text_ascent+j*z-hshift-1);i.restore()}}}else $.publish("/PivotViewer/ImageController/TooltipEnable",[!0])}else $.publish("/PivotViewer/ImageController/TooltipEnable",[!1]);this._breaks?(window.setTimeout(function(){t.animateTiles()},250),this._started=!1):requestAnimFrame(function(){t.animateTiles()})},crossBox:function(t,i,e,s){var h=t[1]-t[0],a=-(e[1]-e[0]),n=i[1]-i[0],o=-(s[1]-s[0]),r=h*o-a*n,l=!1;if(0!=r){var g=o/r,c=-a/r,d=-n/r,v=h/r,f=e[0]-t[0],u=s[0]-i[0],w=g*f+c*u,m=d*f+v*u;l=0<=w&&w<=1&&0<=m&&m<=1}return l},inBox:function(t,i,e,s,h,a,n,o){var r=h<=t&&t<=a,l=h<=i&&i<=a,g=n<=e&&e<=o,c=n<=s&&s<=o;return r&&g||r&&c||l&&g||l&&c},getTextHeight:function(t){var i=$("<span>Hg</span>").css({font:t}),e=$('<div style="display: inline-block; width: 1px; height: 0px;"></div>'),s=$("<div></div>");s.append(i,e),$("body").append(s);try{var h={};e.css({verticalAlign:"baseline"}),h.ascent=e.offset().top-i.offset().top,e.css({verticalAlign:"bottom"}),h.height=e.offset().top-i.offset().top,h.descent=h.height-h.ascent}finally{s.remove()}return h},roundRect:function(t,i,e,s,h,a,n,o){if(void 0===o&&(o=!0),void 0===a&&(a=5),"number"==typeof a)a={tl:a,tr:a,br:a,bl:a};else{var r={tl:0,tr:0,br:0,bl:0};for(var l in r)a[l]=a[l]||r[l]}t.beginPath(),t.moveTo(i+a.tl,e),t.lineTo(i+s-a.tr,e),t.quadraticCurveTo(i+s,e,i+s,e+a.tr),t.lineTo(i+s,e+h-a.br),t.quadraticCurveTo(i+s,e+h,i+s-a.br,e+h),t.lineTo(i+a.bl,e+h),t.quadraticCurveTo(i,e+h,i,e+h-a.bl),t.lineTo(i,e+a.tl),t.quadraticCurveTo(i,e,i+a.tl,e),t.closePath(),n&&t.fill(),o&&t.stroke()},beginAnimation:function(){!this._started&&this._tiles.length>0&&(this._breaks=!1,this.animateTiles())},stopAnimation:function(){this._breaks=!0},setLinearEasingBoth:function(){this._easing=new Easing.Easer({type:"linear",side:"both"})},setCircularEasingBoth:function(){this._easing=new Easing.Easer({type:"circular",side:"both"})},setQuarticEasingOut:function(){this._easing=new Easing.Easer({type:"quartic",side:"out"})},getMaxTileRatio:function(){return this._imageController.MaxRatio}}),PivotViewer.Views.Tile=Object.subClass({init:function(t){if(!(this instanceof PivotViewer.Views.Tile))return new PivotViewer.Views.Tile(t);this._imageLoaded=!1,this._selected=!1,this._images=null,this._locations=[],this._visible=!0},draw:function(t){if(0!=this.width&&0!=this.height){var i=this._locations[t],e=TileController._imageController,s=this.context,h=0,a=0;if(this._images=e.getImages(this.item.img,this.width,this.height),null!=this._images)try{var n=e.getHeight(this.item.img),o=e.getWidth(this.item.img),r=this.height-Math.ceil(this.height<128?this.height/16:8),l=this.width-Math.ceil(this.width<128?this.width/16:8),g=this.width-8-l,c=(this.height,0),d=0;h=l,a=r;var v=e._tileSize,f=Math.ceil(Math.log(this.width>this.height?this.width:this.height)/Math.log(2));f!=1/0&&f!=-1/0||(f=0);var u=e.getMaxLevel(this.item.img);f>u&&(f=u);var w=1<<u-f,m=Math.ceil(n/w),_=Math.ceil(o/w),x=r/m,p=l/_,y=x<p?x:p;if(h=Math.ceil(_*y),a=Math.ceil(m*y),c=Math.floor((l-h)/2),d=Math.floor((r-a)/2),"function"==typeof this._images)this._images(s,i.x+c,i.y+d,h,a);else if(this._images.length>0&&this._images[0]instanceof Image){if(e instanceof PivotViewer.Views.DeepZoomImageController){var v=e._tileSize;lvl=this._images[0].src.match(/_files\/[0-9]+\//g)[0];var b=parseInt(lvl.substring(7,lvl.length-1)),w=1<<e.getMaxLevel(this.item.img)-b,m=Math.ceil(n/w),_=Math.ceil(o/w),x=r/m,p=l/_,y=x<p?x:p;h=_*y,a=m*y,c=Math.floor((l-h)/2),d=Math.floor((r-a)/2),overlap=e.getOverlap(this.item.img);for(var T=0,M=0,C=0;C<this._images.length;C++){var I=this._images[C].src,V=I.match(/[0-9]+_[0-9]+/g),B=V[V.length-1],E=parseInt(B.substring(0,B.indexOf("_"))),L=parseInt(B.substring(B.indexOf("_")+1)),P=Math.floor(this._images[C].height*y),k=Math.floor(this._images[C].width*y),S=(v-overlap)*y,$=c+E*S,A=d+L*S;s.drawImage(this._images[C],$+i.x,A+i.y,k,P);var H=parseInt($+i.x+k),D=parseInt(A+i.y+P);T<H&&(T=H),M<D&&(M=D)}h=parseInt(T-(i.x+c)),a=parseInt(M-(i.y+d))}else{var $=Math.floor(g/2)+4,A=4;s.drawImage(this._images[0],$+i.x,A+i.y,l,r)}if(this._selected){s.beginPath();var $=c,A=d;s.rect($+this._locations[this.selectedLoc].x,A+this._locations[this.selectedLoc].y,h+2,a+2),s.lineWidth=4,s.strokeStyle="#92C4E1",s.stroke()}}}catch(i){this.drawEmpty(t)}else this.drawEmpty(t);var R={};return R.width=h,R.height=a,R.xmargin=c,R.ymargin=d,R}},contains:function(t,e){for(i=0;i<this._locations.length;i++)if(this._locations[i].x<=t&&this._locations[i].x+this.width>=t&&this._locations[i].y<=e&&this._locations[i].y+this.height>=e)return i;return-1},drawEmpty:function(t){var i=TileController._imageController,e=this.context,s=this._locations[t];void 0==i.DrawLevel?(e.beginPath(),e.fillStyle="#D7DDDD",e.fillRect(s.x+4,s.y+4,this.width-8,this.height-8),e.rect(s.x+4,s.y+4,this.width-8,this.height-8),e.lineWidth=1,e.strokeStyle="white",e.stroke()):i.DrawLevel(this.item,e,s.x+4,s.y+4,this.width-8,this.height-8)},now:null,end:null,width:0,height:0,origwidth:0,origheight:0,ratio:1,startwidth:0,startheight:0,destinationwidth:0,destinationheight:0,destinationVisible:!0,context:null,item:null,firstFilterItemDone:!1,selectedLoc:0,setSelected:function(t,i,e){t&&$.publish("/PivotViewer/ImageController/Selected",[this]),this._selected=t,null!=i&&(this.selectedLoc=i),null!=e&&(this.cellLoc=e)},isSelected:function(){return this._selected}}),PivotViewer.Views.TileLocation=Object.subClass({init:function(){},x:0,y:0,startx:0,starty:0,destinationx:0,destinationy:0});