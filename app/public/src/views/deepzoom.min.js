PivotViewer.Views.DeepZoomImageController=PivotViewer.Views.IImageController.subClass({init:function(){this._items=[],this._itemsById=[],this._collageItems=[],this.baseUrl="",this._collageMaxLevel=0,this._collageItemOverlap=1,this._tileSize=256,this._format="",this._ratio=1,this.MaxRatio=0,this._dziQueue=[],this._zooming=!1,this._max_sprite_level=-1,this._sprite_index=[],this._sprite_sheet_url=[],this._sprite_sheet_loaded=[],this._sprite_sheet=[];var e=this;$.subscribe("/PivotViewer/ImageController/Zoom",function(t){e._zooming=t})},setup:function(e){this.baseUrl=e.substring(0,e.lastIndexOf("/")),this._collageUrl=e.substring(e.lastIndexOf("/")+1).replace(".xml","_files"),this.getSpriteIndex(e,this.getDeepzoom)},getSpriteIndex:function(e,t){this._dzc=e,this._cb=t,this._the_other=i;var i=this;$.ajax({type:"GET",url:this.baseUrl+"/sprite.idx",dataType:"xml",success:function(e){var t=$(e).find("SpriteIndex");i._max_sprite_level=$(t).attr("maxdepth");for(var r=$(t).find("Tile"),s=0;s<r.length;s++){for(var a=r[s],o=[],l=$(a).find("TileParams"),n=0;n<l.length;n++){var h=l[n];o[$(h).attr("level")]={width:$(h).attr("width"),height:$(h).attr("height")}}i._sprite_index[$(a).attr("object")]={x:$(a).attr("x"),y:$(a).attr("y"),params:o}}for(var d=$(e).find("SpriteSheet"),v=0;v<d.length;v++){var p=d[v],_=$(p).attr("index");i._sprite_sheet_url[_]=i.baseUrl+"/"+$(p).attr("sprite"),(new Image).src=i._sprite_sheet_url[_]}i._cb(i._dzc)},error:function(e,t,r){i._cb(i._dzc)}})},getDeepzoom:function(e){var t=this;$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){var r=$(e).find("Collection");t._tileSize=$(r).attr("TileSize"),t._format=$(r).attr("Format"),_options.imageFormat=t._format,t._collageMaxLevel=$(r).attr("MaxLevel");var s=$(r).attr("ItemOverlap");t._collageItemOverlap=void 0!=s&&null!=s?s:1,t._tileSize-=2*t._collageItemOverlap;var a=$(r).attr("ImageSrc");void 0!=a&&null!=a&&(t.baseUrl=a);var o=$(e).find("I");if(0==o.length){$(".pv-loading").remove();var l="No items in the DeepZoom Collection<br><br>";return l+="URL        : "+this.url+"<br>",l+="<br>SuAVE cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+l+"</p></div></div>"),void setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}var n=$(o[0]).find("Size");if(n.length>0)for(t.MaxWidth=parseInt(n.attr("Width")),t.Height=parseInt(n.attr("Height")),t.MaxRatio=0,i=0;i<o.length;i++){itemSize=$(o[i]).find("Size");var h=parseInt(itemSize.attr("Width")),d=parseInt(itemSize.attr("Height")),v=h>d?h:d,p=Math.ceil(Math.log(v)/Math.log(2));t._ratio=d/h;var _=$(o[i]).attr("Source"),g=$(o[i]).attr("Id"),m=$(o[i]).attr("N"),u=_.substring(_.lastIndexOf("/")+1).replace(/\.xml/gi,"").replace(/\.dzi/gi,""),c=_.substring(0,_.lastIndexOf("/"));c.length>0&&(c+="/"),h>t.MaxWidth&&(t.MaxWidth=h),t.MaxRatio+=t._ratio;var f=new PivotViewer.Views.DeepZoomItem(g,u,m,c,t._ratio,h,d,p,t.baseUrl,_);t._items.push(f),t._itemsById[g]=f}t.MaxRatio/=o.length,$.publish("/PivotViewer/ImageController/Collection/Loaded",null)},error:function(e,t,i){if(0!=e.readyState||0!=e.status){$(".pv-loading").remove();var r="Error loading from DeepZoom Cache<br><br>";r+="URL        : "+this.url+"<br>",r+="Status : "+e.status+" "+i+"<br>",r+="Details    : "+e.responseText+"<br>",r+="<br>SuAVE cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+r+"</p></div></div>"),setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}}})},getImages:function(e,t,i){var r=this.getLevelFromDimensions(t,i);return this.getImagesAtLevel(e,r)},getLevelFromDimensions:function(e,t){var i=Math.ceil(Math.log(e>t?e:t)/Math.log(2));return i!=1/0&&i!=-1/0||(i=0),i},getImageDimensions:function(e){return this._items[e]},getGoogleMapIcon:function(e,t,i){var r,s=this.getLevelFromDimensions(t,i);if(this._max_sprite_level<0){a=this._itemsById[e];r=(o=this.getImageList(e,this.baseUrl+"/"+a.BasePath+a.DZId+"_files/"+s+"/",s))[0]}else{var a=this._itemsById[e],o=this.getImageList(e,this.baseUrl+"/"+a.BasePath+a.DZId+"_files/"+s+"/",s);r=o[0]}return r},getImagesAtLevel:function(e,t){if(t<0&&(t=0),t<=this._max_sprite_level)return this.spriteLoad(e,t);var i=this._itemsById[e];if(t=t>i.MaxLevel?i.MaxLevel:t,void 0==i.Levels[t]&&!this._zooming){s=this.getImageList(e,this.baseUrl+"/"+i.BasePath+i.DZId+"_files/"+t+"/",t);i.Levels[t]=new PivotViewer.Views.ImageLevel(s)}for(var r=t;r>this._max_sprite_level;r--)if(void 0!=i.Levels[r]&&i.Levels[r].IsLoaded())return i.Levels[r].getImages();if(void 0==i.Levels[t]&&!this._zooming){var s=this.getImageList(e,this.baseUrl+"/"+i.BasePath+i.DZId+"_files/"+t+"/",t);i.Levels[t]=new PivotViewer.Views.ImageLevel(s)}for(var a=null,o=this._max_sprite_level;o>=0&&null==(a=this.spriteLoad(e,o));o--);return a},spriteLoad:function(e,t){var i=null;if(void 0==this._sprite_sheet[t]){if(void 0!=this._sprite_sheet_url[t]&&void 0==this._sprite_sheet_loaded[t]){this._sprite_sheet_loaded[t]=!1,this._sprite_sheet[t]=new Image,this._sprite_sheet[t].src=this._sprite_sheet_url[t];var r=this,s=t;this._sprite_sheet[t].onload=function(){r._sprite_sheet_loaded[s]=!0}}}else if(this._sprite_sheet_loaded[t])try{var a=this._sprite_sheet[t],o=this._sprite_index[e],l=o.params[t],n=1<<t,h=n*o.x,d=n*o.y,v=l.width,p=l.height;i=function(e,t,i,r,s){var o=r/v,l=s/p,n=o<l?o:l,_=Math.floor(v*n),g=Math.floor(p*n),m=Math.floor((r-_)/2),u=Math.floor((s-g)/2);e.drawImage(a,h,d,v,p,t+m,i+u,_,g)}}catch(t){$(".pv-loading").remove();var _="Error in DeepZoom Collection<br><br>";return _+="Unable to find id "+e+"<br>",_+="<br>SuAVE cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+_+"</p></div></div>"),void setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}return i},getImageList:function(e,t,i){for(var r=[],s=this._tileSize,a=this._itemsById[e],o=a.Height,l=a.MaxLevel,n=Math.ceil(o/a.Ratio/Math.pow(2,l-i)),h=Math.ceil(o/Math.pow(2,l-i)),d=Math.ceil(n/s),v=Math.ceil(h/s),p=0;p<d;p++)for(var _=0;_<v;_++)r.push(t+p+"_"+_+"."+this._format);return r},getWidthForImage:function(e,t){return Math.floor(t/this._itemsById[e].Ratio)},getMaxLevel:function(e){return this._itemsById[e].MaxLevel},getHeight:function(e){return this._itemsById[e].Height},getWidth:function(e){return this._itemsById[e].Width},getOverlap:function(e){return this._collageItemOverlap},getRatio:function(e){try{return this._itemsById[e].Ratio}catch(i){$(".pv-loading").remove();var t="Missing image in DeepZoom Collection<br><br>";return t+="Can't find '"+e+"'</br>",t+="<br>SuAVE cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+t+"</p></div></div>"),void setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}}}),PivotViewer.Views.DeepZoomItem=Object.subClass({init:function(e,t,i,r,s,a,o,l,n,h){this.ItemId=e,this.DZId=t,this.DZN=parseInt(i),this.BasePath=r,this.Levels=[],this.Ratio=s,this.Width=a,this.Height=o,this.MaxLevel=l;var d=TileController._imageController._dziQueue[t];"function"==typeof d&&(d=TileController._imageController._dziQueue[t]=void 0),void 0==d?(d=TileController._imageController._dziQueue[t]=[]).push(this):d.push(this)}}),PivotViewer.Views.ImageLevel=Object.subClass({init:function(e){this._images=[],this._loaded=!1;for(var t=this,i=0;i<e.length;i++){var r=new Image;r.src=e[i],r.onload=function(){t._loaded=!0},this._images.push(r)}},getImages:function(){return this._images},IsLoaded:function(){return this._loaded}});