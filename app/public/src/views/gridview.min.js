PivotViewer.Views.GridView=PivotViewer.Views.TileBasedView.subClass({init:function(){this.scale=1,this._super(),this.dontZoom=!1,this.numMissing=0;var t=this;$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(i){if(t.isActive)if(t.dontZoom)t.dontZoom=!1;else{var e=t.scale,s=(t.currentWidth,t.currentHeight,void 0!=i.scale?0:1e3);void 0!=i.scale?i.scale>=1?t.scale+=i.scale-1:(t.scale-=i.scale,t.scale=t.scale<1?1:t.scale):void 0!=i.delta&&(t.scale=0==i.delta?t.scale:t.scale+i.delta),isNaN(t.scale)&&(t.scale=1);var o=(t.width-t.offsetX)*t.scale;if(o<t.width||1==t.scale?(t.currentOffsetX=t.offsetX,t.currentOffsetY=t.offsetY,t.currentWidth=t.width,t.currentHeight=t.height,t.scale=1,t.dontZoom=!0,PV.zoom(0),t.recalibrateUISettings()):(t.currentOffsetX=i.x-(i.x-t.currentOffsetX)/e*t.scale,t.currentOffsetY=i.y-(i.y-t.currentOffsetY)/e*t.scale,t.currentWidth=o,t.currentHeight=(t.height-t.offsetY)*t.scale,t.recalibrateUISettings()),t.setTilePositions(t.rowscols,t.filterList,t.currentOffsetX,t.currentOffsetY,!0,!0,s),1==t.scale&&1!=e){for(var r=0;r<t.tiles.length;r++)t.tiles[r].setSelected(!1);t.selected=null,$.publish("/PivotViewer/Views/Item/Selected",[{item:t.selected,bkt:0}])}}})},resetUISettings:function(){this.rowscols=this.calculateDimensions(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.maxRatio,this.filterList.length-this.numMissing)},recalibrateUISettings:function(){this.rowscols=void 0!=this.rowscols?this.getTileDimensions(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.maxRatio,this.filterList.length-this.numMissing,this.rowscols):this.calculateDimensions(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.maxRatio,this.filterList.length-this.numMissing)},setup:function(t,i,e,s,o){this.width=t,this.height=i,this.offsetX=e,this.offsetY=s,this.maxRatio=o,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY},activate:function(){var t=this;if(Modernizr.canvas){this._super();for(var i=0;i<this.tiles.length;i++)this.tiles[i]._locations=[this.tiles[i]._locations[0]];for(s=0;s<this.tiles.length;s++)this.tiles[s].selectedLoc=0;var e=0;if($(".pv-toolbarpanel-zoomslider").slider("option","value")>0){this.selected=null,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,PV.zoom(0),this.resetUISettings();for(var s=0;s<this.filterList.length;s++){var o=this.filterList[s];o.origwidth=this.rowscols.TileHeight/TileController._imageController.getRatio(o.item.img),o.origheight=this.rowscols.TileHeight}this.setTilePositions(this.rowscols,this.tiles,this.currentOffsetX,this.currentOffsetY,!0,!1,1e3),e=1e3}setTimeout(function(){for(var i=0;i<t.tiles.length;i++){var e=t.tiles[i];if(e._locations[0].startx=e._locations[0].x,e._locations[0].starty=e._locations[0].y,e.startwidth=e.width,e.startheight=e.height,!e.filtered||!Settings.showMissing&&e.missing){e.start=PivotViewer.Utils.now(),e.end=e.start+1e3;var s=Math.atan2(e._locations[0].y-t.currentHeight/2,e._locations[0].x-t.currentWidth/2);e._locations[0].destinationx=t.currentWidth*Math.cos(s)+t.currentWidth/2,e._locations[0].destinationy=t.currentHeight*Math.sin(s)+t.currentHeight/2,e.destinationwidth=1,e.destinationheight=1}}var o=t.filterList.length==t.tiles.length?0:500;setTimeout(function(){if(t.numMissing=0,!Settings.showMissing)for(i=0;i<t.filterList.length;i++)t.filterList[i].missing&&t.numMissing++;t.resetUISettings();for(var i=0;i<t.tiles.length;i++){var e=t.tiles[i];e.origwidth=t.rowscols.TileHeight/TileController._imageController.getRatio(e.item.img),e.origheight=t.rowscols.TileHeight}t.setTilePositions(t.rowscols,t.filterList,t.offsetX,t.offsetY,!1,!1,1e3)},o)},e)}},getButtonImage:function(){return"images/GridView.png"},getButtonImageSelected:function(){return"images/GridViewSelected.png"},getViewName:function(){return"Grid View"},setTilePositions:function(t,i,e,s,o,r,n){var h=r&&this.rowscols?this.rowscols.Columns:t.Columns;r||(this.rowscols=t);for(var l=0,c=0,a=0;a<i.length;a++){var f=i[a];!Settings.showMissing&&f.missing||(o&&(f._locations[0].startx=f._locations[0].x,f._locations[0].starty=f._locations[0].y,f.startwidth=f.width,f.startheight=f.height),f.destinationwidth=t.TileMaxWidth,f.destinationheight=t.TileHeight,f._locations[0].destinationx=l*t.TileMaxWidth+e,f._locations[0].destinationy=c*t.TileHeight+s,f.start=PivotViewer.Utils.now(),f.end=f.start+n,l==h-1?(l=0,c++):l++)}},centerOnTile:function(t){var i=Math.round((t._locations[0].x-this.currentOffsetX)/t.width),e=Math.round((t._locations[0].y-this.currentOffsetY)/t.height),s=t.context.canvas.height,o=t.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width());t.height/s>t.height/TileController._imageController.getRatio(t.item.img)/o?origProportion=t.origheight/s:origProportion=t.origwidth/o,null==this.selected&&PV.zoom(Math.round(.75/origProportion*2)),this.currentOffsetX=this.rowscols.TileMaxWidth*-i+this.width/2-this.rowscols.TileMaxWidth/2,this.currentOffsetY=this.rowscols.TileHeight*-e+this.height/2-this.rowscols.TileHeight/2,this.setTilePositions(this.rowscols,this.filterList,this.currentOffsetX,this.currentOffsetY,!0,!0,1e3)},handleClick:function(t){var i=this._super(t);null!=i&&i.setSelected(!0),"init"==t.type&&this.resetUISettings(),null!=i&&this.selected!=i?this.centerOnTile(i):(this.selected=i=null,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,PV.zoom(0)),$.publish("/PivotViewer/Views/Item/Selected",[{item:i}])}});