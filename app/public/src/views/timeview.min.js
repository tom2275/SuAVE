PivotViewer.Views.TimeView=PivotViewer.Views.IPivotViewerView.subClass({init:function(){var t,i,n;for(this._super(),this.selectedFacet=0,this.default_showBubble=Timeline.OriginalEventPainter.prototype._showBubble,this.timeFacets=[],t=0;t<PivotCollection.FacetCategories.length;t++)i=PivotCollection.FacetCategories[t],i.Type==PivotViewer.Models.FacetType.DateTime&&this.timeFacets.push({name:i.Name});this.theme=Timeline.ClassicTheme.create();n=this;Timeline.OriginalEventPainter.prototype._showBubble=function(t,i,r){if(n.selected!=null&&n.selected.facetItem.Id==r._id)n.SetSelected(null),$.publish("/PivotViewer/Views/Item/Selected",[{item:u}]);else{var u=TileController.GetTileById(r._id);n.SetSelected(u);$.publish("/PivotViewer/Views/Item/Selected",[{item:u}])}};this.theme.autoWidth=!1},Setup:function(n,t,i,r){this.width=n;this.height=t;this.offsetX=i;this.offsetY=r;this.currentWidth=this.width;this.currentHeight=this.height;this.currentOffsetX=this.offsetX;this.currentOffsetY=this.offsetY},Activate:function(){var u,i,r,t,n;if(Modernizr.canvas){for(this._super(),$(".pv-toolbarpanel-timelineselector").fadeIn(),$(".pv-timeview-canvas").fadeIn(),$(".pv-timeview-canvas").css("height",this.height-12+"px"),$(".pv-timeview-canvas").css("width",this.width-415+"px"),$("#MAIN_BODY").css("overflow","hidden"),$(".pv-toolbarpanel-timelineselector").empty(),u="<select id='pv-timeline-selectcontrol' style='width:126px'>",i=0;i<this.timeFacets.length;i++)u+="<option "+(i==this.selectedFacet?"Facetselected='selected' ":"")+"value='"+i+"'>"+this.timeFacets[i].name+"<\/option>";u+="<\/select>";$(".pv-toolbarpanel-timelineselector").append(u);r=this;$("#pv-timeline-selectcontrol").change(function(){r.selectedFacet=$("#pv-timeline-selectcontrol").val();r.RefreshView();r.timeline.getBand(0).setCenterVisibleDate(r.timeFacets[r.selectedFacet].eventsData[this.selected.facetItem.Id+"a"].getStart());$.publish("/PivotViewer/Views/Item/Updated",null)});t=PivotCollection.GetFacetCategoryByName(this.timeFacets[this.selectedFacet].name);t.uiInit||PV.InitUIFacet(t);n=this.timeFacets[this.selectedFacet];n.interval0==undefined&&(t.datetimeBuckets.decade!=undefined&&t.datetimeBuckets.decade.length>1?(n.interval0=Timeline.DateTime.YEAR,n.interval1=Timeline.DateTime.DECADE):t.datetimeBuckets.year!=undefined&&t.datetimeBuckets.year.length>1?(n.interval0=Timeline.DateTime.MONTH,n.interval1=Timeline.DateTime.YEAR):t.datetimeBuckets.month!=undefined&&t.datetimeBuckets.month.length>1?(n.interval0=Timeline.DateTime.DAY,n.interval1=Timeline.DateTime.MONTH):t.datetimeBuckets.day!=undefined&&t.datetimeBuckets.day.length>1?(n.interval0=Timeline.DateTime.HOUR,n.interval1=Timeline.DateTime.DAY):(n.interval0=Timeline.DateTime.DAY,n.interval1=Timeline.DateTime.MINUTE));this.filtered&&this.Filter(this.filterEvt.tiles,this.filterEvt.filter)}},Deactivate:function(){this._super();$(".pv-timeview-canvas").fadeOut();$(".pv-toolbarpanel-timelineselector").fadeOut()},Filter:function(n,t){var f=this,i,u,r;if(Debug.Log("Timeline View Filtered: "+t.length),this.selected=null,this.tiles=n,this.filter=t,this.CreateEventsData(),i=this.timeFacets[this.selectedFacet],this.timeFacets.length==0||i.eventsData.length==0){this.ShowTimeError();return}u=new Timeline.DefaultEventSource;r=[Timeline.createBandInfo({eventSource:u,date:i.eventsData[0].getStart(),width:"80%",intervalUnit:i.interval0,intervalPixels:100,theme:this.theme}),Timeline.createBandInfo({overview:!0,date:i.eventsData[0].getStart(),eventSource:u,width:"20%",intervalUnit:i.interval1,intervalPixels:200,theme:this.theme})];r[1].highlight=!0;r[1].syncWith=0;r[1].decorators=[new Timeline.SpanHighlightDecorator({inFront:!1,color:"#FFC080",opacity:30,startLabel:"Begin",endLabel:"End",theme:this.theme})];this.timeline=Timeline.create($(".pv-timeview-canvas")[0],r,Timeline.HORIZONTAL);this.timeline.showLoadingMessage();Timeline.loadJSON("timeline.json",function(n,t){u.loadJSON(n,t)});this.timeline.hideLoadingMessage();this.RefreshView();this.filtered=!1},GetUI:function(){return""},GetButtonImage:function(){return"images/TimeView.png"},GetButtonImageSelected:function(){return"images/TimeViewSelected.png"},GetViewName:function(){return"Time View"},CreateEventsData:function(){var i,t,n,r,u;for(this.timeFacets[this.selectedFacet].eventsData=[],i=0;i<this.filter.length;i++)for(t=0;t<this.timeFacets.length;t++)n=this.filter[i],r=n.facetItem.FacetByName[this.timeFacets[t].name],r!=undefined&&(u=new Timeline.DefaultEventSource.Event({id:n.facetItem.Id,start:new Date(r.FacetValues[0].Value),isDuration:!1,text:n.facetItem.Name,image:n._images?n._images[0].attributes[0].value:null,link:n.facetItem.Href,caption:n.facetItem.Name,description:n.facetItem.Description}),this.timeFacets[t].eventsData.push(u),this.timeFacets[t].eventsData[n.facetItem.Id+"a"]=u)},ShowTimeError:function(){var n="",t;n=n+"The current data selection does not contain any information that can be shown on a timeline<br><br>";n=n+"<br>Choose a different view<br>";$(".pv-wrapper").append('<div id="pv-dzlocation-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+n+"<\/p><\/div><\/div>");t=setTimeout(function(){window.open("#pv-dzlocation-error","_self")},1e3);return},RefreshView:function(){this.timeline.getBand(0).getEventSource().clear();this.timeline.getBand(0).getEventSource().addMany(this.timeFacets[this.selectedFacet].eventsData);this.timeline.paint()},SetSelected:function(n){if(this.selected!=null&&(this.timeFacets[this.selectedFacet].eventsData[this.selected.facetItem.Id+"a"]._icon=Timeline.urlPrefix+"images/dull-blue-circle.png"),this._super(n),n!=null){var t=this.timeFacets[this.selectedFacet].eventsData[this.selected.facetItem.Id+"a"];this.timeline.getBand(0).setCenterVisibleDate(t.getStart());t._icon=Timeline.urlPrefix+"images/dark-red-circle.png"}}});
