function locateBucket(e){for(var t=0;t<bucketRules.length;t++)if(bucketRules[t].value[0]==e)return t}PivotViewer.Utils.loadScript("src/views/definebuckets.js");var cIndex;$(document).on("click","#new-page",function(){window.open().document.write('<link href="style/bootstrap.css" rel="stylesheet" type="text/css" /><title>Rules Table</title><code><pre id="new-rule-result" style="position: relative;">'+$("#pv-rule-result").html()+"</pre></code>")}),$(document).on("click","#pv-rule-info",function(){var e=PivotCollection.items.length;$("#ruleModal").modal("toggle"),void 0!=bucketRules[cIndex].value[1]?$("#table_header").html("Value to be explained(X): "+bucketRules[cIndex].name+"; Values: "+bucketRules[cIndex].value[0]+" to "+bucketRules[cIndex].value[1]):$("#table_header").html("Value to be explained(X): "+bucketRules[cIndex].name+"; Values: "+bucketRules[cIndex].value[0]),$("#header_info").html("Total items with value X: "+Cs[cIndex].length+" out of "+e+" ("+Math.round(Cs[cIndex].length/e*100)+"%)");var t,s,i,l,a,n;if(t=ruleFilters[0].name,l="string"==ruleFilters[0].type?ruleFilters[0].value.join(", "):"from "+ruleFilters[0].value[0]+" to "+ruleFilters[0].value[1],$("#filter_values").html("A: "+t+": "+l+" ("+A.length+" out of "+e+", or "+Math.round(A.length/e*100)+"%)"),void 0!=ruleFilters[1]&&(s=ruleFilters[1].name,a="string"==ruleFilters[1].type?ruleFilters[1].value.join(", "):"from "+ruleFilters[1].value[0]+" to "+ruleFilters[1].value[1],$("#filter_values").append("<br>B: "+s+": "+a+" ("+B.length+" out of "+e+", or "+Math.round(B.length/e*100)+"%)")),void 0!=ruleFilters[2]&&(i=ruleFilters[2].name,n="string"==ruleFilters[2].type?ruleFilters[2].value.join(", "):"from "+ruleFilters[2].value[0]+" to "+ruleFilters[2].value[1],$("#filter_values").append("<br>C: "+i+": "+n+" ("+D.length+" out of "+e+", or "+Math.round(D.length/e*100)+"%)")),void 0!=ruleFilters[2]?$("#rule_explain").html("Explainatory rule: if A and B and C then X"):void 0!=ruleFilters[1]?$("#rule_explain").html("Explainatory rule: if A and B then X"):$("#rule_explain").html("Explainatory rule: if A then X"),$("#explain_values").html('<td id="explain" class="rules" style="white-space:normal;"></td><td id="total_ax" class="rules" style="white-space:normal;"></td><td id="total_a_items" class="rules" style="white-space:normal;"></td><td id="total_acc" class="rules" style="white-space:normal;"></td><td id="total_cpl" class="rules" style="white-space:normal;"></td>'),$("#explanation").html('<th class="rules" style="white-space:normal;">Explanation</th><th id="rule_one" class="rules" style="white-space:normal;"></th><th id="rule_two" class="rules" style="white-space:normal;"></th><th id="rule_three" class="rules" style="white-space:normal;"></th><th id="rule_four" class="rules" style="white-space:normal;"></th><th id="rule_five" class="rules" style="white-space:normal;"></th>'),void 0!=ruleFilters[2]){$("#rule_one").html("Total items that have A, B, C and X"),$("#rule_two").html("Total items that have A, B and C"),$("#rule_three").html("Accuracy of explanation,  N(ABCX)/N(ABC)"),$("#rule_four").html("Completeness of explanation, N(ABCX)/N(X)"),$("#rule_five").html("Contribution of A into accuracy of explanation"),$("#explanation").append('<th class="rules_six" style="white-space:normal;">Contribution of B into accuracy of explanation</th>'),$("#explanation").append('<th class="rules_seven" style="white-space:normal;">Contribution of B into accuracy of explanation</th>'),$("#explain").html("ABC->X"),$("#total_ax").html(ABDCs[cIndex].length),$("#total_a_items").html(ABD.length),$("#total_acc").html(ABDCs[cIndex].length+" out of "+ABD.length+" or "+Math.round(ABDCs[cIndex].length/ABD.length*100)+"%"),$("#total_cpl").html(ABDCs[cIndex].length+" out of "+Cs[cIndex].length+" or "+Math.round(ABDCs[cIndex].length/Cs[cIndex].length*100)+"%");var o=Math.round(ABDCs[cIndex].length/ABD.length*100)-Math.round(BDCs[cIndex].length/BD.length*100),r=Math.round(ABDCs[cIndex].length/ABD.length*100)-Math.round(ADCs[cIndex].length/AD.length*100),h=Math.round(ABDCs[cIndex].length/ABD.length*100)-Math.round(ABCs[cIndex].length/AB.length*100);o>10?$("#explain_values").append("<td class='danger'>"+o+"%</td>"):o<-10?$("#explain_values").append("<td class='info'>"+o+"%</td>"):$("#explain_values").append("<td class='success rules' style='white-space:normal;'>"+o+"%</td>"),r>10?$("#explain_values").append("<td class='danger rules' style='white-space:normal;'>"+r+"%</td>"):r<-10?$("#explain_values").append("<td class='info rules' style='white-space:normal;'>"+r+"%</td>"):$("#explain_values").append("<td class='success rules' style='white-space:normal;'>"+r+"%</td>"),h>10?$("#explain_values").append("<td class='danger rules' style='white-space:normal;'>"+h+"%</td>"):h<-10?$("#explain_values").append("<td class='info rules' style='white-space:normal;'>"+h+"%</td>"):$("#explain_values").append("<td class='success rules' style='white-space:normal;'>"+h+"%</td>")}else if(void 0!=ruleFilters[1]){$("#rule_one").html("Total items that have A, B and X"),$("#rule_two").html("Total items that have A and B"),$("#rule_three").html("Accuracy of explanation,  N(ABX)/N(AB)"),$("#rule_four").html("Completeness of explanation, N(ABX)/N(X)"),$("#rule_five").html("Contribution of A into accuracy of explanation"),$("#explanation").append('<th class="rules" style="white-space:normal;">Contribution of B into accuracy of explanation</th>'),$("#explain").html("AB->X"),$("#total_ax").html(ABCs[cIndex].length),$("#total_a_items").html(AB.length),$("#total_acc").html(ABCs[cIndex].length+" out of "+AB.length+" or "+Math.round(ABCs[cIndex].length/AB.length*100)+"%"),$("#total_cpl").html(ABCs[cIndex].length+" out of "+Cs[cIndex].length+" or "+Math.round(ABCs[cIndex].length/Cs[cIndex].length*100)+"%");var o=Math.round(ABCs[cIndex].length/AB.length*100)-Math.round(BCs[cIndex].length/B.length*100),r=Math.round(ABCs[cIndex].length/AB.length*100)-Math.round(ACs[cIndex].length/A.length*100);o>10?$("#explain_values").append("<td class='danger'>"+o+"%</td>"):o<-10?$("#explain_values").append("<td class='info'>"+o+"%</td>"):$("#explain_values").append("<td class='success rules' style='white-space:normal;'>"+o+"%</td>"),r>10?$("#explain_values").append("<td class='danger rules' style='white-space:normal;'>"+r+"%</td>"):r<-10?$("#explain_values").append("<td class='info rules' style='white-space:normal;'>"+r+"%</td>"):$("#explain_values").append("<td class='success rules' style='white-space:normal;'>"+r+"%</td>")}else{$("#rule_one").html("Total items that have A and X"),$("#rule_two").html("Total items that have A"),$("#rule_three").html("Accuracy of explanation,  N(AX)/N(A)"),$("#rule_four").html("Completeness of explanation, N(AX)/N(X)"),$("#rule_five").html("Contribution of A into accuracy of explanation"),$("#explain").html("A->X"),$("#total_ax").html(ACs[cIndex].length),$("#total_a_items").html(A.length);o=Math.round(ACs[cIndex].length/A.length*100)-Math.round(Cs[cIndex].length/e*100);$("#total_acc").html(ACs[cIndex].length+" out of "+A.length+" or "+Math.round(ACs[cIndex].length/A.length*100)+"%"),$("#total_cpl").html(ACs[cIndex].length+" out of "+Cs[cIndex].length+" or "+Math.round(ACs[cIndex].length/Cs[cIndex].length*100)+"%"),o>10?$("#explain_values").append("<td class='danger'>"+o+"%</td>"):o<-10?$("#explain_values").append("<td class='info'>"+o+"%</td>"):$("#explain_values").append("<td class='success rules' style='white-space:normal;'>"+o+"%</td>")}$("#accum_explain").html(""),void 0!=ruleFilters[2]?($("#accum_explain").append("Accuracy of explanatory rule “if A and B then X” is N(ABX)/N(AB) = "+Math.round(ABCs[cIndex].length/AB.length*100)+"% ("+ABCs[cIndex].length+" out of "+AB.length+")"),$("#accum_explain").append("<br>Accuracy of explanatory rule “if B and C then X” is N(BCX)/N(BC) = "+Math.round(BDCs[cIndex].length/BD.length*100)+"% ("+BDCs[cIndex].length+" out of "+BD.length+")"),$("#accum_explain").append("<br>Accuracy of explanatory rule “if A and C then X” is N(ACX)/N(AC) = "+Math.round(ADCs[cIndex].length/AD.length*100)+"% ("+ADCs[cIndex].length+" out of "+AD.length+")")):void 0!=ruleFilters[1]&&($("#accum_explain").append("Accuracy of explanatory rule “if A then X” is N(AX)/N(A) = "+Math.round(ACs[cIndex].length/A.length*100)+"% ("+ACs[cIndex].length+" out of "+A.length+")"),$("#accum_explain").append("<br>Accuracy of explanatory rule “if B then X” is N(BX)/N(B) = "+Math.round(BCs[cIndex].length/B.length*100)+"% ("+BCs[cIndex].length+" out of "+B.length+")"))}),PivotViewer.Views.BucketView=PivotViewer.Views.TileBasedView.subClass({init:function(){this._super();var e=this;this.buckets=[],this.scale=1,this.canvasHeightUIAdjusted=0,this.titleSpace=62,this.dontZoom=!1,PV.subsets=[null,null],PV.subsets.finalized=!1,$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(t){if(e.isActive)if(e.dontZoom)e.dontZoom=!1;else{var s=e.scale;t.scale;void 0!=t.scale?t.scale>=1?e.scale+=t.scale-1:(e.scale-=t.scale,e.scale<1&&(e.scale=1)):void 0!=t.delta&&(e.scale=e.scale+t.delta),isNaN(e.scale)&&(e.scale=1),e.scale>51&&(e.scale=51);var i=(e.width-e.offsetX)*e.scale;if(i<e.width||e.scale<=1)e.currentOffsetX=e.offsetX,e.currentOffsetY=e.offsetY,e.currentWidth=e.width,e.currentHeight=e.height,e.canvasHeightUIAdjusted=e.height-e.offsetY-e.titleSpace,e.columnWidth=e.origColumnWidth,e.scale=1,$(".pv-bucketview-overlay div").fadeIn("slow"),e.dontZoom=!0,PV.zoom(0),e.recalibrateUISettings();else{var l=e.height*e.scale;e.currentOffsetX=t.x-(t.x-e.currentOffsetX)/s*e.scale,e.currentOffsetY=t.y-(t.y-e.currentOffsetY)/s*e.scale,e.canvasHeightUIAdjusted=l-(e.offsetY+e.titleSpace)/s*e.scale,e.currentWidth=i,e.currentHeight=l,e.columnWidth=e.origColumnWidth*e.scale,$(".pv-bucketview-overlay div").fadeOut("slow"),e.resetUISettings()}if(e.scale!=s&&e.setTilePositions(e.rowscols,e.currentOffsetX,e.currentOffsetY,!0,!0),1==e.scale&&1!=s){for(var a=0;a<e.tiles.length;a++)e.tiles[a].setSelected(!1,null);e.selected=null,$.publish("/PivotViewer/Views/Item/Selected",[{item:e.selected}])}}})},getBucket:function(e){return Math.floor((e-this.offsetX)/this.columnWidth)},recalibrateUISettings:function(){this.rowscols=this.getTileDimensions(this.columnWidth-2,this.canvasHeightUIAdjusted-this.offsetY,this.maxRatio,this.bigCount,this.rowscols)},resetUISettings:function(){this.rowscols=this.calculateDimensions(this.columnWidth-2,this.canvasHeightUIAdjusted-this.offsetY,this.maxRatio,this.bigCount)},handleFilter:function(e,t,s){void 0!=e&&(this.tiles=e),void 0!=t&&(this.oldFilterList=this.filterList,this.filterList=t),void 0!=s&&(this.sortCategory=s),this.filtered=!0,this.isActive&&this.activate()},setup:function(e,t,s,i,l){this.width=e,this.height=t,this.offsetX=s,this.offsetY=i,this.maxRatio=l,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,this.rowscols=null,this.bigCount=0},activate:function(){this._super(),DB.isOn()||DB.on(),this.createUI()},filter:function(){PV.subsets.finalized?this.buckets=this.subset(this.filterList,this.sortCategory):this.buckets=this.bucketize(this.filterList,this.sortCategory)},createUI:function(){this.columnWidth=this.origColumnWidth=(this.width-this.offsetX)/this.buckets.length,this.canvasHeightUIAdjusted=this.height-this.offsetY-this.titleSpace;var e="";this.bigCount=0;for(l=0;l<this.buckets.length;l++){var t=this.buckets[l],s=l%2==0?"bucketview-bucket-dark":"bucketview-bucket-light";(t.equals(PV.subsets[0])||t.equals(PV.subsets[1]))&&(s+=" pv-bucketview-subset");var i=(t.startRange==t.endRange||t.startLabel==t.endLabel?t.startLabel:t.startLabel+"<br>to<br>"+t.endLabel)+(PV.subsets.finalized?l%2?" (2)":" (1)":"");e+="<div class='pv-bucketview-overlay-bucket "+s+"' id='pv-bucketview-overlay-bucket-"+l+"' style='width: "+(Math.floor(this.columnWidth)-4)+"px; height:"+(this.height-2)+"px; left:"+(l*this.columnWidth-2)+"px;'>",e+="<div class='pv-bucketview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'><div class='pv-bucket-countbox'>"+this.buckets[l].tiles.length+"<br>"+Math.round(this.buckets[l].tiles.length/this.filterList.length*100)+"%</div>"+i+"</div></div>",this.bigCount<t.tiles.length&&(this.bigCount=t.tiles.length)}$(".pv-viewpanel-view").append('<div class="modal fade" id="ruleModal"><div class="modal-dialog" id="rule-modal"><div class="modal-content"><div class="modal-header"><h4 class="modal-title">Rule Table</h4></div><div class="modal-body" ><code><pre id="pv-rule-result" style="position: relative;         "><h3 id="table_header"></h3><div class="table-responsive"><h3 id="table_header"></h3><h3 id="header_info"></h3><div class="table-responsive" ><table class="table" ><tr><th>Values in filter:</th></tr><tr><td id="filter_values"></td></tr><tr><td id="rule_explain">explainary rule</td></tr></table></div><div class="table-responsive" ><table class="table" ><tr id="explanation"><th class="rules" style="white-space:normal;">Explanation</th><th id="rule_one" class="rules" style="white-space:normal;"></th><th id="rule_two" class="rules" style="white-space:normal;"></th><th id="rule_three" class="rules" style="white-space:normal;"></th><th id="rule_four" class="rules" style="white-space:normal;"></th><th id="rule_five" class="rules" style="white-space:normal;"></th></tr><tr id="explain_values"><td id="explain" class="rules" style="white-space:normal;"></td><td id="total_ax" class="rules" style="white-space:normal;"></td><td id="total_a_items" class="rules" style="white-space:normal;"></td><td id="total_acc" class="rules" style="white-space:normal;"></td><td id="total_cpl" class="rules" style="white-space:normal;"></td></tr></table></div><div class="table-responsive" ><table class="table" ><tr ><td id="accum_explain"></td></tr></table></div></pre></code></div><div class="modal-footer"><button type="button" class="btn btn-default" id="new-page">Open in new window</button><button id="close-rule" type="button" class="btn btn-default" data-dismiss="modal">Close</button></div></div></div></div>'),$(".pv-viewpanel-view").append("<div class='pv-bucketview-overlay'></div>"),$(".pv-bucketview-overlay").css("left",this.offsetX+"px").append(e),$(".pv-bucketview-overlay div").fadeIn("slow");for(var l=0;l<this.tiles.length;l++){var a=this.tiles[l];this.currentWidth=$(".pv-canvas").width();for(var n=a._locations,o=0;o<n.length;o++)n[o].startx=n[o].x,n[o].starty=n[o].y;if(a.startwidth=a.width,a.startheight=a.height,!a.filtered||!Settings.showMissing&&a.missing){a.start=PivotViewer.Utils.now(),a.end=a.start+1e3;for(o=0;o<n.length;o++){var r=Math.atan2(n[o].y-this.currentHeight/2,n[o].x-this.currentWidth/2);n[o].destinationx=Math.abs(this.currentWidth*Math.cos(r)+this.currentWidth/2),n[o].destinationy=this.currentHeight*Math.sin(r)+this.currentHeight/2}}}var h=this.filterList.length==this.tiles.length?0:500,c=this;setTimeout(function(){$(".pv-toolbarpanel-zoomslider").slider("option","value")>0&&(c.selected=selectedTile=null,c.currentOffsetX=c.offsetX,c.currentOffsetY=c.offsetY,c.resetUISettings(),PV.zoom(0)),c.resetUISettings();for(var e=TileController._imageController,t=0;t<c.tiles.length;t++)c.tiles[t].origwidth=c.rowscols.TileHeight/e.getRatio(c.tiles[t].item.img),c.tiles[t].origheight=c.rowscols.TileHeight,c.tiles[t].destinationwidth=1,c.tiles[t].destinationheight=1;c.setTilePositions(c.rowscols,c.offsetX,c.offsetY,!1,!1)},h)},deactivate:function(){this._super(),$(".pv-bucketview-overlay div").fadeOut()},getButtonImage:function(){return"images/BucketView.png"},getButtonImageSelected:function(){return"images/BucketViewSelected.png"},getViewName:function(){return"Bucket View"},setTilePositions:function(e,t,s,i,l){var a=l&&this.rowscols?this.rowscols.Columns:e.Columns;l||(this.rowscols=e);for(v=0;v<this.tiles.length;v++)this.tiles[v].firstFilterItemDone=!1,this.tiles[v]._locations=[this.tiles[v]._locations[0]];for(var n=0;n<this.buckets.length;n++)for(var o=this.buckets[n],r=0,h=0,c=0;c<o.tiles.length;c++){var u=o.tiles[c];if(u.firstFilterItemDone)tileLocation=new PivotViewer.Views.TileLocation,tileLocation.startx=u._locations[0].startx,tileLocation.starty=u._locations[0].starty,tileLocation.x=u._locations[0].x,tileLocation.y=u._locations[0].y,tileLocation.destinationx=n*this.columnWidth+r*e.TileMaxWidth+t,tileLocation.destinationy=this.canvasHeightUIAdjusted-e.TileHeight-h*e.TileHeight+s,u._locations.push(tileLocation);else{var d=u._locations;if(i){for(v=0;v<d.length;v++)d[v].startx=d[v].x,d[v].starty=d[v].y;u.startwidth=u.width,u.startheight=u.height}u.destinationwidth=e.TileMaxWidth,u.destinationheight=e.TileHeight;for(var v=0;v<d.length;v++)d[v].destinationx=n*this.columnWidth+r*e.TileMaxWidth+t,d[v].destinationy=this.canvasHeightUIAdjusted-e.TileHeight-h*e.TileHeight+s;u.start=PivotViewer.Utils.now(),u.end=u.start+1e3,u.firstFilterItemDone=!0}r==a-1?(r=0,h++):r++}},bucketize:function(e,t,s){void 0==s&&(s=10);var i=PivotCollection.getCategoryByName(t);if("db"==$(".pv-facet[facet='"+PV.cleanName(t).toLowerCase()+"']").attr("mode")){var l=DB.getBuckets(t);return PivotViewer.Utils.fillBuckets(l,e,t),l}if(void 0==e[0].item.getFacetByName(t)){var a=[];return P=new PivotViewer.Models.Bucket("(no info)","(no info)"),a.push(P),a.ids=[],a}for(var n=e[0].item.getFacetByName(t).values[0].value,o=e.length-1;o>0&&void 0==e[o].item.getFacetByName(t);o--);var r=e[o].item.getFacetByName(t).values[0].value;if(i.isDateTime())return n=new Date(n),r=new Date(r),PivotViewer.Utils.getBuckets(e,t,PivotViewer.Utils.getTimeValueFn(n,r),PivotViewer.Utils.getTimeLabelFn(n,r));if(i.isNumber()){var h=[];h.ids=[];var c,u,d,v=r-n;0==v?(c=1,u=n,d=1):(c=Math.pow(10,Math.ceil(Math.log(v)/Math.log(10))-1),i.integer&&c<=1?c=1:v<=5*c&&(c/=2),u=Math.floor(n/c)*c,(d=Math.floor((r-u)/c)+1)>s&&(c*=2,d=Math.ceil(d/2)));for(o=0;o<d;o++){var f=o*c+u,g=f+c;h[o]=new PivotViewer.Models.Bucket(f,f,f.toString(),g.toString())}for(o=0;o<e.length;o++){var p=e[o].item,b=p.getFacetByName(t);if(void 0==b)break;for(var m=0;m<b.values.length;m++){var w=b.values[m].value;(P=h[M=Math.floor((w-u)/c)]).addTile(e[o]),h.ids[p.id]=M,P.endRange<w&&(P.endRange=w)}}for(var x=c,y=0;y<h.length;y++){var A=(P=h[y]).startRange+c-P.endRange;A<x&&(x=A)}c-=(x=Math.pow(10,Math.floor(Math.log(x)/Math.log(10))))>1?1:x;for(y=0;y<h.length;y++)h[y].startRange;for(var C=0,y=0;y<h.length;y++)0==h[y].tiles.length&&C++;if(C>=Math.floor(h.length/2)){var _=[];_.ids=[];for(y=0;y<h.length>>1;y++){var B=h[2*y],k=h[2*y+1];_.push(B),Array.prototype.push.apply(B.tiles,k.tiles);for(var I in B.ids)_.ids[I]=y;for(var I in k.ids)B.ids[I]=!0,_.ids[I]=y;B.endRange=k.endRange,B.endLabel=k.endLabel}var V=2*y;if(V<h.length){P=h[V];_.push(P);for(var I in P.ids)_.ids[I]=y}h=_}if(o!=e.length&&Settings.showMissing){h.push(new PivotViewer.Models.Bucket("(no info)","(no info)")),h.ids=[];for(var M=h.length-1,P=h[M];o<e.length;o++)P.addTile(e[o]),P.ids[e[o].item.id]=!0,h.ids[e[o].item.id]=M}return h}return PivotViewer.Utils.getBuckets(e,t)},centerOnTile:function(e){var t,s=e.item,i=e._locations[e.selectedLoc],l=this.rowscols.TileMaxWidth,a=this.rowscols.PaddingX;t=this.buckets.ids[s.id]instanceof Array?this.buckets.ids[s.id][e.selectedLoc]:this.buckets.ids[s.id];var n,o=this.rowscols.Columns,r=t*o+Math.round((i.x-this.currentOffsetX-t*(o*l+a))/l),h=Math.round((this.canvasHeightUIAdjusted-(i.y-this.currentOffsetY))/e.height)-1,c=e.context.canvas.height,u=e.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width());n=e.height/c>e.height/TileController._imageController.getRatio(s.img)/u?e.origheight/c:e.origwidth/u,null==this.selected&&PV.zoom(Math.round(.75/n*2));a=this.rowscols.PaddingX*t;this.currentOffsetX=this.width/2-this.rowscols.TileMaxWidth*r-this.rowscols.TileMaxWidth/2-a,this.currentOffsetY=this.height/2-this.canvasHeightUIAdjusted+this.rowscols.TileHeight/2+h*this.rowscols.TileHeight,this.setTilePositions(this.rowscols,this.currentOffsetX,this.currentOffsetY,!0,!0)},handleHover:function(e){if(null==this.selected){for(var t=0;t<this.buckets.length;t++)for(var s=0;s<this.buckets[t].tiles.length;s++){var i=this.buckets[t].tiles[s].contains(e.x,e.y);i>=0?this.buckets[t].tiles[s].setSelected(!0,i):this.buckets[t].tiles[s].setSelected((!1).null)}$(".pv-tooltip").remove(),$(".pv-bucketview-overlay-bucket").removeClass("bucketview-bucket-hover");var l=this.getBucket(e.x);if(l>=0&&($("#pv-bucketview-overlay-bucket-"+l).addClass("bucketview-bucket-hover"),!(this.scale>1))){var a=$(".pv-bucketview-overlay-buckettitle").eq(l),n=a.offset();if(e.x>=n.left&&e.x<=n.left+a.width()&&e.y<=n.top&&e.y>=n.top-a.height()){var o=this.buckets[l],r=PivotCollection.getCategoryByName(this.sortCategory).type==PivotViewer.Models.FacetType.String,h=1==ruleNums||2==ruleNums||3==ruleNums;cIndex=locateBucket(o.startRange);var c="<div class='pv-tooltip'>"+this.sortCategory+" Bucket "+(l+1)+":<br>"+(o.startLabel==o.endLabel?" Value: "+(r?'"':"")+o.startLabel+(r?'"':"")+"; ":"Values: from "+(r?'"':"")+o.startLabel+(r?'"':"")+"  to "+(r?'"':"")+o.endLabel+(r?'"':"")+"; ")+o.tiles.length+" of "+this.filterList.length+" items ("+Math.round(o.tiles.length/this.filterList.length*100)+"%)           "+(void 0!=A[0]?"<br><i>Without filter(s): "+Cs[cIndex].length+" of "+PivotCollection.items.length+" items ("+Math.round(Cs[cIndex].length/PivotCollection.items.length*100)+"%)</i> ":"");if(void 0!=A[0]){var u=Math.round(o.tiles.length/this.filterList.length*100)-Math.round(Cs[cIndex].length/PivotCollection.items.length*100);c+=u>10?'<br><i><font color="red">Contribution of filter(s): '+u+"%</font></i>":u<-10?'<br><i><font color="blue">Contribution of filter(s): '+u+"%</font></i>":'<br><i><font color="green">Contribution of filter(s): '+u+"%</font></i>"}c+=h?"<button type = 'button' id='pv-rule-info' >more info</button>":"",c+=Settings.showMissing?"</div>":"<br><i>(Some items may be missing values for this variable.)</i></div>",$(".pv-viewpanel").append(c),$(".pv-tooltip").offset({left:n.left,top:n.top-a.height()+$(".pv-canvas").offset().top+10})}}}},handleClick:function(e){if(this.hasSubsets()&&!PV.subsets.finalized)return PV.subsets.finalized=!0,void PV.filterViews();var t=this._super(e);if("init"==e.type&&(this.resetUISettings(),1==_options.authoring&&(t.selectedLoc=PARA.selected_loc)),null!=this.selected&&this.selected.setSelected(!1),null!=t)this.selected!=t?(1==_options.authoring&&(PARA.selected_loc=t.selectedLoc),t.setSelected(!0,null),this.centerOnTile(t),this.setSelected(t),$(".pv-bucketview-overlay div").fadeOut("slow")):(t=null,this.setSelected(null),PV.zoom(0),$(".pv-bucketview-overlay div").fadeIn("slow"));else{this.setSelected(null),PV.zoom(0),$(".pv-bucketview-overlay div").fadeIn("slow");var s=this.getBucket(e.x);if(s>=0&&s<this.buckets.length){var i=this.buckets[s];$.publish("/PivotViewer/Views/Item/Filtered",[{category:this.sortCategory,min:i.startRange,max:i.endRange,values:i.values,clearFilters:!0}])}}$.publish("/PivotViewer/Views/Item/Selected",[{item:t}])},handleContextMenu:function(e){if(!PV.subsets.finalized){var t=this.getBucket(e.x),s=$("#pv-bucketview-overlay-bucket-"+t);this.addSubset(this.buckets[t])?s.addClass("pv-bucketview-subset"):s.removeClass("pv-bucketview-subset")}},addSubset:function(e){if(0==e.tiles.length)return!1;PV.subsets.finalized=!1;var t=this.getSubset(e.tiles[0].item.id);if(-1!=t)return 0==t&&(PV.subsets[0]=PV.subsets[1]),PV.subsets[1]=null,null==PV.subsets[0]&&this.clearSubsets(),!1;if(null!=PV.subsets[1])return!1;if(null==PV.subsets[0]){$(".pv-filterpanel-clearall").after("<div class='pv-subset-clear'>Subset</div>");var s=this;$(".pv-subset-clear").css("visibility","visible").on("click.subset",function(){s.clearSubsets()}),$(".pv-filterpanel-clearall").css("visibility","visible").on("click.subset",function(){s.clearSubsets()}),PV.subsets[0]=e}else PV.subsets[1]=e;return!0},subset:function(e,t){for(var s=[],i=0;i<e.length;i++){var l=e[i];null!=PV.subsets[1]&&-1==this.getSubset(l.item.id)||s.push(l)}var a=this.bucketize(s,t,5),n=[];n.ids=[];for(i=0;i<a.length;i++){var o=a[i];n[2*i]=new PivotViewer.Models.Bucket(o.startRange,o.startLabel,o.endRange,o.endLabel),n[2*i+1]=new PivotViewer.Models.Bucket(o.startRange,o.startLabel,o.endRange,o.endLabel);for(c=0;c<o.tiles.length;c++){var r=(l=o.tiles[c]).item.id,h=2*i+(PV.subsets[0].ids[r]?0:1);n[h].addTile(l),n.ids[r]=h}for(var c=0;c<o.values.length;c++)n[h].addValue(o.values[c])}return n},getSubset:function(e){return null==PV.subsets[0]?-1:PV.subsets[0].ids[e]?0:null!=PV.subsets[1]&&PV.subsets[1].ids[e]?1:-1},hasSubsets:function(){return null!=PV.subsets[0]},clearSubsets:function(){PV.subsets[0]=PV.subsets[1]=null,PV.subsets.finalized=!1,PV.filterViews(),$(".pv-subset-clear").remove(),$(".pv-filterpanel-clearall").off("click.subset"),this.tiles.length==this.filterList.length&&$(".pv-filterpanel-clearall").css("visibility","hidden")}});