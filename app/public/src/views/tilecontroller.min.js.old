PivotViewer.Views.TileController=Object.subClass({init:function(t){this._tiles=[],this._tilesById=[],this._easing=new Easing.Easer({type:"circular",side:"both"}),this._imageController=t;var i=this;this._tiles.push=function(t){this.__proto__.push.apply(i._tiles,[t]),i._tilesById[t.item.id]=t},this.isZooming=!1,this._started=!1,this.isFirefox="undefined"!=typeof InstallTrigger},getTileById:function(t){var i=this._tilesById[t];return void 0==i?null:i},initTiles:function(t,i,e){for(var s=0;s<t.length;s++){var h=new PivotViewer.Views.Tile(this._imageController);h.item=t[s],this._canvasContext=e,h.context=this._canvasContext,tileLocation=new PivotViewer.Views.TileLocation,h._locations.push(tileLocation),this._tiles.push(h)}return this._tiles},animateTiles:function(){var t=this;this._started=!0;var i=null,e=this._tiles;if(this._breaks=!1,e.length>0&&null!=e[0].context)for(var s=(i=e[0].context).canvas.width=$(".pv-canvas").width(),h=i.canvas.height=$(".pv-canvas").height(),n=!1,a=0;a<e.length;a++){V=(I=e[a])._locations;for(B=0;B<V.length;B++){var o=V[B],r=PivotViewer.Utils.now()-I.start,l=I.end-I.start;r<=l?(o.x==o.destinationx&&o.y==o.destinationy||(n=!0),o.x=this._easing.ease(r,o.startx,o.destinationx-o.startx,l),o.y=this._easing.ease(r,o.starty,o.destinationy-o.starty,l),I.width==I.destinationWidth&&I.height==I.destinationHeight||(n=!0),I.width=this._easing.ease(r,I.startwidth,I.destinationwidth-I.startwidth,l),I.height=this._easing.ease(r,I.startheight,I.destinationheight-I.startheight,l)):(o.x=o.destinationx,o.y=o.destinationy,I.width=I.destinationwidth,I.height=I.destinationheight)}}this._isZooming!=n&&(this._isZooming=n,$.publish("/PivotViewer/ImageController/Zoom",[this._isZooming])),i.clearRect(0,0,i.canvas.width,i.canvas.height);var g=new Array(e.length);(i=e[0].context).font="12px Roboto,Helvetica,Arial,sans-serif";for(var c=0,d=0,v=0,f=0,u=0,s=i.canvas.width,h=i.canvas.height,a=0;a<e.length;a++){V=(I=e[a])._locations;g[a]=new Array(V.length);for(B=0;B<V.length;B++){var m=(o=V[B]).x,w=o.y,_=m+I.width,x=w+I.height;(this.inBox(m,_,w,x,0,s,0,h)||this.inBox(0,s,0,h,m,_,w,x)||this.crossBox([m,_],[x,x],[0,0],[0,h])||this.crossBox([m,_],[w,w],[0,0],[0,h])||this.crossBox([m,_],[x,x],[s,s],[0,h])||this.crossBox([m,_],[w,w],[s,s],[0,h])||this.crossBox([0,s],[0,0],[m,m],[x,w])||this.crossBox([0,s],[h,h],[m,m],[x,w])||this.crossBox([0,s],[0,0],[_,_],[x,w])||this.crossBox([0,s],[h,h],[_,_],[x,w]))&&(void 0!=I.item.name&&(c+=(W=i.measureText(I.item.name)).width,W.width>v&&(v=W.width),d+=I.item.name.length,I.item.name.length>f&&(f=I.item.name.length)),g[a][B]=I.draw(B),u<I.width&&(u=I.width))}}if(f>0){var p=u-24,y=Math.floor(p/v*12);y>30&&(y=30);var b=y>=12;if(!b){var T=c/d,C=p+3*T;for(f-=3;f>=20&&!b;f--)b=(y=Math.floor(C/(f*T)*12))>=12}if(b){$.publish("/PivotViewer/ImageController/TooltipEnable",[!1]),i.font=y+"px Roboto,Helvetica,Arial,sans-serif";var M=this.getTextHeight(i.font);y=M.height,text_ascent=M.ascent,text_descent=M.descent;for(a=0;a<e.length;a++)for(var I=e[a],V=I._locations,B=0;B<V.length;B++){var E=g[a][B];if(void 0!=E&&0!=E.width){o=V[B];var P=E.width,L=E.height,k=E.xmargin,S=E.ymargin,A=I.item.name,D=[];if(A.length>f){for(var R=A.split(" "),H="",O=0;O<R.length;O++){var q=H.length+R[O].length;H.length>0&&q++,q>f?(D.push(H),H=R[O]):H+=" "+R[O]}D.push(H),D.length>3&&(D=[]).push(A.substr(0,f-3)+"...")}else D.push(A);for(var Z=0,F=0;F<D.length;F++){var W=i.measureText(D[F]);Z<W.width&&(Z=W.width)}var j=y,z=D.length*j,Q=(o=V[B]).x+k,U=o.y+S;i.save(),i.strokeStyle="rgb( 0, 0, 0 )",i.fillStyle="rgba( 64, 64, 64, .5 )";var G=Z+8,J=z;hshift=this.isFirefox?4:8,this.roundRect(i,Q+(P-G)/2,U+L-(J+hshift),G,J,4,!0,!1),i.restore(),i.save(),i.textBaseline="alphabetic",i.textAlign="center",i.fillStyle="white";for(F=0;F<D.length;F++)i.fillText(D[F],Q+P/2,U-z+L+text_ascent+F*j-hshift-1);i.restore()}}}else $.publish("/PivotViewer/ImageController/TooltipEnable",[!0])}else $.publish("/PivotViewer/ImageController/TooltipEnable",[!1]);this._breaks?(window.setTimeout(function(){t.animateTiles()},250),this._started=!1):requestAnimFrame(function(){t.animateTiles()})},crossBox:function(t,i,e,s){var h=t[1]-t[0],n=-(e[1]-e[0]),a=i[1]-i[0],o=-(s[1]-s[0]),r=h*o-n*a,l=!1;if(0!=r){var g=o/r,c=-n/r,d=-a/r,v=h/r,f=e[0]-t[0],u=s[0]-i[0],m=g*f+c*u,w=d*f+v*u;l=0<=m&&m<=1&&0<=w&&w<=1}return l},inBox:function(t,i,e,s,h,n,a,o){var r=h<=t&&t<=n,l=h<=i&&i<=n,g=a<=e&&e<=o,c=a<=s&&s<=o;return r&&g||r&&c||l&&g||l&&c},getTextHeight:function(t){var i=$("<span>Hg</span>").css({font:t}),e=$('<div style="display: inline-block; width: 1px; height: 0px;"></div>'),s=$("<div></div>");s.append(i,e),$("body").append(s);try{var h={};e.css({verticalAlign:"baseline"}),h.ascent=e.offset().top-i.offset().top,e.css({verticalAlign:"bottom"}),h.height=e.offset().top-i.offset().top,h.descent=h.height-h.ascent}finally{s.remove()}return h},roundRect:function(t,i,e,s,h,n,a,o){if(void 0===o&&(o=!0),void 0===n&&(n=5),"number"==typeof n)n={tl:n,tr:n,br:n,bl:n};else{var r={tl:0,tr:0,br:0,bl:0};for(var l in r)n[l]=n[l]||r[l]}t.beginPath(),t.moveTo(i+n.tl,e),t.lineTo(i+s-n.tr,e),t.quadraticCurveTo(i+s,e,i+s,e+n.tr),t.lineTo(i+s,e+h-n.br),t.quadraticCurveTo(i+s,e+h,i+s-n.br,e+h),t.lineTo(i+n.bl,e+h),t.quadraticCurveTo(i,e+h,i,e+h-n.bl),t.lineTo(i,e+n.tl),t.quadraticCurveTo(i,e,i+n.tl,e),t.closePath(),a&&t.fill(),o&&t.stroke()},beginAnimation:function(){!this._started&&this._tiles.length>0&&(this._breaks=!1,this.animateTiles())},stopAnimation:function(){this._breaks=!0},setLinearEasingBoth:function(){this._easing=new Easing.Easer({type:"linear",side:"both"})},setCircularEasingBoth:function(){this._easing=new Easing.Easer({type:"circular",side:"both"})},setQuarticEasingOut:function(){this._easing=new Easing.Easer({type:"quartic",side:"out"})},getMaxTileRatio:function(){return this._imageController.MaxRatio}}),PivotViewer.Views.Tile=Object.subClass({init:function(t){if(!(this instanceof PivotViewer.Views.Tile))return new PivotViewer.Views.Tile(t);this._imageLoaded=!1,this._selected=!1,this._images=null,this._locations=[],this._visible=!0},draw:function(t){if(0!=this.width&&0!=this.height){var i=this._locations[t],e=TileController._imageController,s=this.context,h=0,n=0;if(this._images=e.getImages(this.item.img,this.width,this.height),null!=this._images)try{var a=e.getHeight(this.item.img),o=e.getWidth(this.item.img),r=this.height-Math.ceil(this.height<128?this.height/16:8),l=this.width-Math.ceil(this.width<128?this.width/16:8),g=this.width-8-l,c=(this.height,0),d=0;h=l,n=r;var v=e._tileSize,f=Math.ceil(Math.log(this.width>this.height?this.width:this.height)/Math.log(2));f!=1/0&&f!=-1/0||(f=0);var u=e.getMaxLevel(this.item.img);f>u&&(f=u);var m=1<<u-f,w=Math.ceil(a/m),_=Math.ceil(o/m),x=r/w,p=l/_,y=x<p?x:p;if(h=Math.ceil(_*y),n=Math.ceil(w*y),c=Math.floor((l-h)/2),d=Math.floor((r-n)/2),"function"==typeof this._images)this._images(s,i.x+c,i.y+d,h,n);else if(this._images.length>0&&this._images[0]instanceof Image){if(e instanceof PivotViewer.Views.DeepZoomImageController){v=e._tileSize;lvl=this._images[0].src.match(/_files\/[0-9]+\//g)[0];var b=parseInt(lvl.substring(7,lvl.length-1)),m=1<<e.getMaxLevel(this.item.img)-b,w=Math.ceil(a/m);h=(_=Math.ceil(o/m))*(y=(x=r/w)<(p=l/_)?x:p),n=w*y,c=Math.floor((l-h)/2),d=Math.floor((r-n)/2),overlap=e.getOverlap(this.item.img);for(var T=0,C=0,M=0;M<this._images.length;M++){var I=this._images[M].src.match(/[0-9]+_[0-9]+/g),V=I[I.length-1],B=parseInt(V.substring(0,V.indexOf("_"))),E=parseInt(V.substring(V.indexOf("_")+1)),P=Math.floor(this._images[M].height*y),L=Math.floor(this._images[M].width*y),k=(v-overlap)*y,S=c+B*k,$=d+E*k;s.drawImage(this._images[M],S+i.x,$+i.y,L,P);var A=parseInt(S+i.x+L),D=parseInt($+i.y+P);T<A&&(T=A),C<D&&(C=D)}h=parseInt(T-(i.x+c)),n=parseInt(C-(i.y+d))}else{var S=Math.floor(g/2)+4,$=4;s.drawImage(this._images[0],S+i.x,$+i.y,l,r)}if(this._selected){s.beginPath();var S=c,$=d;s.rect(S+this._locations[this.selectedLoc].x,$+this._locations[this.selectedLoc].y,h+2,n+2),s.lineWidth=4,s.strokeStyle="#92C4E1",s.stroke()}}}catch(i){this.drawEmpty(t)}else this.drawEmpty(t);var R={};return R.width=h,R.height=n,R.xmargin=c,R.ymargin=d,R}},contains:function(t,e){for(i=0;i<this._locations.length;i++)if(this._locations[i].x<=t&&this._locations[i].x+this.width>=t&&this._locations[i].y<=e&&this._locations[i].y+this.height>=e)return i;return-1},drawEmpty:function(t){var i=TileController._imageController,e=this.context,s=this._locations[t];void 0==i.DrawLevel?(e.beginPath(),e.fillStyle="#D7DDDD",e.fillRect(s.x+4,s.y+4,this.width-8,this.height-8),e.rect(s.x+4,s.y+4,this.width-8,this.height-8),e.lineWidth=1,e.strokeStyle="white",e.stroke()):i.DrawLevel(this.item,e,s.x+4,s.y+4,this.width-8,this.height-8)},now:null,end:null,width:0,height:0,origwidth:0,origheight:0,ratio:1,startwidth:0,startheight:0,destinationwidth:0,destinationheight:0,destinationVisible:!0,context:null,item:null,firstFilterItemDone:!1,selectedLoc:0,setSelected:function(t,i,e){t&&$.publish("/PivotViewer/ImageController/Selected",[this]),this._selected=t,null!=i&&(this.selectedLoc=i),null!=e&&(this.cellLoc=e)},isSelected:function(){return this._selected}}),PivotViewer.Views.TileLocation=Object.subClass({init:function(){},x:0,y:0,startx:0,starty:0,destinationx:0,destinationy:0});