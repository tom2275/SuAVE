PivotViewer.Utils.loadScript("src/views/bucketview.min.js"),PivotViewer.Views.CrosstabView=PivotViewer.Views.BucketView.subClass({init:function(){this._super();var t=this;0==$("#pv-altsortcontrols").length&&($("#pv-primsortcontrols").before("<div id='pv-altsortcontrols' class='pv-toolbarpanel-sortcontrols'></div>"),$("#pv-altsortcontrols").hide(),$("#pv-primsort").clone(!0).attr("id","pv-altsort").appendTo($("#pv-altsortcontrols")),1==_options.authoring&&PV.getGraphParameters(),$("#pv-altsort").on("change",function(e){if(void 0!=t.bucketsY){t.sortCategory2=$("#pv-altsort option:selected").html(),1==_options.authoring&&(PARA.y_axis=t.sortCategory2);var s=PivotCollection.getCategoryByName(t.sortCategory2);s.uiInit||PV.initUICategory(s);var i=t.filterList.slice(0).sort(tileSortBy(t.sortCategory2));if(Settings.showMissing)t.filterList2=i;else{t.filterList2=[];for(var o=0;o<i.length;o++){var l=i[o];void 0!=l.item.getFacetByName(t.sortCategory2)&&t.filterList2.push(l)}}t.bucketsY=t.bucketize(t.filterList2,t.sortCategory2),t.subbucketize(),1==_options.authoring&&PV.getGraphParameters(),t.activate()}}))},getBucket:function(t){return Math.floor((t-this.offsetX-this.columnWidth)/this.columnWidth)},getBucketY:function(t){return this.bucketsY.length-Math.floor(t/this.rowHeight)-1},recalibrateUISettings:function(){this.rowscols=this.getTileDimensions((this.origColumnWidth-4)*this.scale,(this.rowHeight-4)*this.scale,this.maxRatio,this.bigCount,this.rowscols)},resetUISettings:function(){this.rowscols=this.calculateDimensions((this.origColumnWidth-4)*this.scale,(this.rowHeight-4)*this.scale,this.maxRatio,this.bigCount)},subbucketize:function(){for(i=0;i<this.buckets.length;i++){var t=this.buckets[i];t.subBuckets=[],t.colCount=0;for(var e=0;e<this.bucketsY.length;e++){var s=this.bucketsY[e];t.subBuckets.push(new PivotViewer.Models.Bucket(s.startRange,s.startLabel,s.endRange,s.endLabel))}}for(var i=0;i<this.filterList.length;i++){var o=this.filterList[i],l=o.item.id,h=this.buckets.ids[l],r=this.bucketsY.ids[l];if(void 0!=h&&void 0!=r){h instanceof Array||(h=[h]),r instanceof Array||(r=[r]);for(var a=0;a<h.length;a++)for(var n=0;n<r.length;n++)this.buckets[h[a]].subBuckets[r[n]].addTile(o),this.buckets[h[a]].colCount++}}},filterY:function(){if(void 0==this.bucketsY)this.sortCategory2=$("#pv-primsort option:selected").html(),$("#pv-altsort").val($("#pv-primsort").val()),this.bucketsY=this.buckets,this.filterList2=this.filterList;else{var t=[];if(this.filterList.length<this.oldFilterList.length)for(i=0;i<this.filterList2.length;i++){o=this.filterList2[i];void 0!=this.buckets.ids[o.item.id]&&t.push(o)}else{for(var e=[],s=PivotCollection.getCategoryByName(this.sortCategory2),i=0;i<this.filterList.length;i++){var o=this.filterList[i];void 0!=this.bucketsY.ids[o.item.id]||!Settings.showMissing&&void 0==o.item.getFacetByName(this.sortCategory2)||e.push(o)}e.sort(tileSortBy(this.sortCategory2));for(var i=0,l=0;i<this.filterList2.length&&l<e.length;){var h,r,a=this.filterList2[i],n=e[l],c=a.item.getFacetByName(this.sortCategory2),u=n.item.getFacetByName(this.sortCategory2);void 0!=c?void 0!=u?(s.isDateTime()?(h=new Date(c.values[0].value),r=new Date(u.values[0].value)):(h=c.values[0].value,r=u.values[0].value),h<r?(t.push(a),i++):(t.push(n),l++)):(t.push(a),i++):(t.push(n),l++)}for(;i<this.filterList2.length;)t.push(this.filterList2[i++]);for(;l<e.length;)t.push(e[l++])}this.filterList2=t,"db"==$(".pv-facet[facet='"+PV.cleanName(this.sortCategory2).toLowerCase()+"']").attr("mode")?(this.bucketsY=DB.getBuckets(this.sortCategory2),PivotViewer.Utils.fillBuckets(this.bucketsY,this.filterList2,this.sortCategory2)):this.bucketsY=this.bucketize(this.filterList2,this.sortCategory2)}this.subbucketize()},filter:function(){this.buckets=this.bucketize(this.filterList,this.sortCategory),this.filterY()},createUI:function(){$("#pv-altsortcontrols").show(),this.columnWidth=this.origColumnWidth=(this.width-this.offsetX)/(this.buckets.length+1),this.canvasHeightUIAdjusted=this.height-this.offsetY-this.titleSpace,this.rowHeight=this.canvasHeightUIAdjusted/this.buckets[0].subBuckets.length;var t="<div class='pv-bucketview-overlay-bucket' style='width: "+(this.columnWidth-4)+"px; height:"+this.height+"px;''>";this.bigCount=0;for(h=0;h<this.bucketsY.length;h++){l=(e=this.bucketsY[h]).startRange==e.endRange||e.startLabel==e.endLabel?l=e.startLabel:e.startLabel+" to "+e.endLabel;t+="<div class='pv-bucketview-overlay-buckettitle-left' style='top: "+(this.bucketsY.length-1-h)*this.rowHeight+"px; height: "+(this.rowHeight-4)+"px; width: "+(this.columnWidth-4)+"px'><div class='pv-bucket-countbox'>"+this.bucketsY[h].tiles.length+"<br>"+Math.round(this.bucketsY[h].tiles.length/this.filterList2.length*100)+"%</div><div class='pv-bucket-label'>"+l+"</div></div>"}t+=this.getStatsBox()+"</div>";for(h=0;h<this.buckets.length;h++){var e=this.buckets[h];t+="<div class='pv-bucketview-overlay-bucket' style='width: "+(this.columnWidth-4)+"px; left:"+(h+1)*this.columnWidth+"px; height:"+this.height+"px;'>";for(var s=e.subBuckets.length-1;s>=0;s--){var i=e.subBuckets[s],o=h%2==s%2?"bucketview-bucket-dark":"bucketview-bucket-light";(i.equals(PV.subsets[0])||i.equals(PV.subsets[1]))&&(o+=" pv-bucketview-subset"),t+="<div style='height:"+this.rowHeight+"px; top:"+s*this.rowHeight+"px;'><div class='pv-crosstabview-overlay-bucket "+o+"' style='height:"+(this.rowHeight-4)+"px; top: "+s*this.rowHeight+"px;'></div></div>",this.bigCount<i.tiles.length&&(this.bigCount=i.tiles.length)}var l=e.startRange==e.endRange||e.startLabel==e.endLabel?l="<div class='pv-bucket-label'>"+e.startLabel+"</div>":e.startLabel+"<br>to<br>"+e.endLabel;t+="<div class='pv-bucketview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"';'><div class='pv-bucket-countbox'>"+this.buckets[h].colCount+"<br>"+Math.round(this.buckets[h].colCount/this.filterList2.length*100)+"%</div>"+l+"</div></div></div>"}$(".pv-viewpanel-view").append("<div class='pv-bucketview-overlay'></div>"),$(".pv-bucketview-overlay").css("left",this.offsetX+"px").append(t),$(".pv-bucketview-overlay div").fadeIn("slow");for(var h=0;h<this.tiles.length;h++){var r=this.tiles[h],a=r._locations[0];if(a.startx=a.x,a.starty=a.y,r.startwidth=r.width,r.startheight=r.height,!r.filtered||!Settings.showMissing&&r.missing){r.start=PivotViewer.Utils.now(),r.end=r.start+1e3;var n=Math.atan2(a.y-this.currentHeight/2,a.x-this.currentWidth/2);a.destinationx=this.currentWidth*Math.cos(n)+this.currentWidth/2,a.destinationy=this.currentHeight*Math.sin(n)+this.currentHeight/2}}var c=this.filterList.length==this.tiles.length?0:500,u=this;setTimeout(function(){$(".pv-toolbarpanel-zoomslider").slider("option","value")>0&&(u.selected=selectedTile=null,u.currentOffsetX=u.offsetX,u.currentOffsetY=u.offsetY,u.resetUISettings(),PV.zoom(0)),u.resetUISettings();for(var t=TileController._imageController,e=0;e<u.tiles.length;e++)u.tiles[e].origwidth=u.rowscols.TileHeight/t.getRatio(u.tiles[e].item.img),u.tiles[e].origheight=u.rowscols.TileHeight,u.tiles[e].destinationwidth=1,u.tiles[e].destinationheight=1;u.setTilePositions(u.rowscols,u.offsetX,u.offsetY,!1,!1)},c)},deactivate:function(){this._super(),$("#pv-altsortcontrols").hide()},getButtonImage:function(){return"images/CrossTabView.png"},getButtonImageSelected:function(){return"images/CrossTabViewSelected.png"},getViewName:function(){return"Crosstab View"},setTilePositions:function(t,e,s,i,o){var l=o&&this.rowscols?this.rowscols.Columns:t.Columns;o||(this.rowscols=t);for(var h=0;h<this.tiles.length;h++)this.tiles[h].firstFilterItemDone=!1,this.tiles[h]._locations=[this.tiles[h]._locations[0]];for(var r=this.rowHeight*this.scale,a=0;a<this.buckets.length;a++)for(var n=this.buckets[a],c=0;c<n.subBuckets.length;c++)for(var u=n.subBuckets[c],v=0,g=0,d=0;d<u.tiles.length;d++){var b=u.tiles[d];if(b.firstFilterItemDone)(f=new PivotViewer.Views.TileLocation).startx=b._locations[0].startx,f.starty=b._locations[0].starty,f.x=b._locations[0].x,f.y=b._locations[0].y,f.destinationx=(a+1)*this.columnWidth+v*t.TileMaxWidth+e,f.destinationy=this.canvasHeightUIAdjusted-c*r-t.TileHeight-g*t.TileHeight+s-10,b._locations.push(f);else{var f=b._locations[0];i&&(f.startx=f.x,f.starty=f.y,b.startwidth=b.width,b.startheight=b.height),b.destinationwidth=t.TileMaxWidth,b.destinationheight=t.TileHeight,f.destinationx=(a+1)*this.columnWidth+v*t.TileMaxWidth+e,f.destinationy=this.canvasHeightUIAdjusted-c*r-t.TileHeight-g*t.TileHeight+s-10,b.start=PivotViewer.Utils.now(),b.end=b.start+1e3,b.firstFilterItemDone=!0}v==l-1?(v=0,g++):v++}},centerOnTile:function(t){var e,s,i=t._locations[t.selectedLoc],o=t.item,l=this.rowscols.Columns,h=this.rowscols.Rows,r=this.rowscols.TileMaxWidth,a=this.rowscols.TileHeight;e=this.buckets.ids[o.id]instanceof Array?this.buckets.ids[o.id][t.cellLoc[0]]:this.buckets.ids[o.id],s=this.bucketsY.ids[o.id]instanceof Array?this.bucketsY.ids[o.id][t.cellLoc[1]]:this.bucketsY.ids[o.id];for(var n=Math.round((i.x-this.currentOffsetX-(e+1)*this.columnWidth)/r),c=h-Math.floor((i.y-this.currentOffsetY-(this.bucketsY.length-s-1)*this.rowHeight*this.scale-this.rowscols.PaddingY)/a),u=this.buckets[e].subBuckets[s],v=c*l+n;(v>u.tiles.length||u.tiles[v]!=t)&&v>=0;)c--,v-=l;var g,d=t.context.canvas.height,b=t.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width());g=t.height/d>t.height/TileController._imageController.getRatio(o.img)/b?t.origheight/d:t.origwidth/b,null==this.selected&&PV.zoom(Math.round(.75/g*2)),this.currentOffsetX=this.width/2-this.rowscols.TileMaxWidth/2-(e+1)*this.columnWidth-n*this.rowscols.TileMaxWidth,this.currentOffsetY=this.height/2-this.canvasHeightUIAdjusted+this.rowscols.TileHeight/2+s*this.rowHeight*this.scale+c*this.rowscols.TileHeight+10,this.setTilePositions(this.rowscols,this.currentOffsetX,this.currentOffsetY,!0,!0)},getStatsBox:function(){for(var t,e=0,s=0;s<this.buckets.length;s++)if(0!=(t=this.buckets[s]).tiles.length)for(var i=0;i<this.bucketsY.length;i++){var o=this.bucketsY[i];if(0!=o.tiles.length){var l=t.tiles.length*o.tiles.length/this.filterList.length,h=l-t.subBuckets[i].tiles.length;e+=h*h/l}}e=Math.floor(100*e)/100;var r=pochisq(e,this.buckets.length,t.subBuckets.length),a="";return r<.001?a="***":r<.01?a="**":r<.05&&(a="*"),"<div class='pv-crosstabview-overlay-statsbox' style='position:absolute; width: "+(this.columnWidth-4)+"px; height: 50px; top: "+this.bucketsY.length*this.rowHeight+"px;'><div style='text-align:center'>"+this.sortCategory2+"</div><div class='pv-bucket-countbox' title='chi-squared'>X<sup>2</sup><br>"+e+a+"</div><div style='position:absolute; right:2px;'>"+this.sortCategory+"</div></div>"},handleHover:function(t){if(null==this.selected){for(var e=0;e<this.buckets.length;e++)for(var s=0;s<this.buckets[e].tiles.length;s++){var i=this.buckets[e].tiles[s].contains(t.x,t.y);if(i>=0){for(var o,l,h=this.buckets[e].tiles[s].item.facets,r=0;r<h.length;r++)h[r].name==this.sortCategory2&&(o=i%h[r].values.length,l=Math.floor(i/h[r].values.length));this.buckets[e].tiles[s].setSelected(!0,i,[l,o])}else this.buckets[e].tiles[s].setSelected((!1).null)}if($(".pv-crosstabview-overlay-bucket").removeClass("bucketview-bucket-hover"),$(".pv-tooltip").remove(),!(this.scale>1)){var a=this.getBucket(t.x),n=this.getBucketY(t.y);if(a>=0&&n>=0)$(".pv-crosstabview-overlay-bucket").eq(a*this.bucketsY.length+(this.bucketsY.length-n-1)).addClass("bucketview-bucket-hover");else{var c,u,v,g;if(!(a<-1||n<-1)){if(-1==a){if(-1==n)return $(".pv-bucketview-overlay").append("<div class='pv-tooltip'>chi-squared</div>"),void $(".pv-tooltip").offset($(".pv-crosstabview-overlay-statsbox").offset());v=n,c=$(".pv-bucketview-overlay-buckettitle-left").eq(v),u=this.bucketsY[v],g=this.sortCategory2}else{if(-1!=n)return;v=a,c=$(".pv-bucketview-overlay-buckettitle").eq(v),u=this.buckets[v],g=this.sortCategory}var d=PivotCollection.getCategoryByName(g).isString(),b="<div class='pv-tooltip'>"+g+" Bucket "+(v+1)+":<br>"+(u.startLabel==u.endLabel?" Value: "+(d?'"':"")+u.startLabel+(d?'"':"")+"<br>":"Values: from "+(d?'"':"")+u.startLabel+(d?'"':"")+"  to "+(d?'"':"")+u.endLabel+(d?'"':"")+"<br>")+u.tiles.length+" of "+this.filterList2.length+" items ("+Math.round(u.tiles.length/this.filterList2.length*100)+"%)"+(Settings.showMissing?"</div>":"<br><i>(Some items may be missing values for this variable.)</i></div>");$(".pv-bucketview-overlay").append(b),$(".pv-tooltip").offset(c.offset())}}}}},handleClick:function(t){if(this.hasSubsets()&&!PV.subsets.finalized)return PV.subsets.finalized=!0,void PV.filterViews();var e=this.super_handleClick(t);if("init"==t.type&&(this.resetUISettings(),(this.buckets.ids[e.item.id]instanceof Array||this.bucketsY.ids[e.item.id]instanceof Array)&&null==e.cellLoc)){e.selectedLoc=PARA.selected_loc;for(var s=e.item.facets,i=0;i<s.length;i++)if(s[i].name==this.sortCategory2){var o=e.selectedLoc%s[i].values.length,l=Math.floor(e.selectedLoc/s[i].values.length);e.cellLoc=[l,o]}}if(null!=this.selected&&this.selected.setSelected(!1),null!=e)this.selected!=e?(1==_options.authoring&&(PARA.selected_loc=e.selectedLoc),e.setSelected(!0,null),this.centerOnTile(e),this.setSelected(e),$(".pv-bucketview-overlay div").fadeOut("slow")):(e=null,this.setSelected(null),PV.zoom(0),$(".pv-bucketview-overlay div").fadeIn("slow"));else{this.setSelected(null),PV.zoom(0),$(".pv-bucketview-overlay div").fadeIn("slow");var h=this.getBucket(t.x),r=this.getBucketY(t.y);if(h>=0){var a=this.buckets[h];if(r>=0){n=this.bucketsY[r];$.publish("/PivotViewer/Views/Item/Filtered",[[{category:this.sortCategory,min:a.startRange,max:a.endRange,values:a.values},{category:this.sortCategory2,min:n.startRange,max:n.endRange,values:n.values}]])}else $.publish("/PivotViewer/Views/Item/Filtered",[{category:this.sortCategory,min:a.startRange,max:a.endRange,values:a.values}])}else if(r>=0){var n=this.bucketsY[r];$.publish("/PivotViewer/Views/Item/Filtered",[{category:this.sortCategory2,min:n.startRange,max:n.endRange,values:n.values}])}}$.publish("/PivotViewer/Views/Item/Selected",[{item:e}])},handleContextMenu:function(t){var e=this.getBucket(t.x),s=this.getBucketY(t.y),i=$(".pv-crosstabview-overlay-bucket").eq(e*this.bucketsY.length+(this.bucketsY.length-s-1));this.addSubset(this.buckets[e].subBuckets[s])?i.addClass("pv-bucketview-subset"):i.removeClass("pv-bucketview-subset")}});