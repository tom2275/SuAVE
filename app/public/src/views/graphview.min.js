PivotViewer.Views.GraphView=PivotViewer.Views.TileBasedView.subClass({init:function(){this.Scale=1,this._super(),this.dontZoom=!1,this.tileHeight=0;var t=this;$.subscribe("/PivotViewer/Views/Canvas/Click",function(e){if(t.isActive){for(var i=null,s=0;s<t.tiles.length;s++)t.tiles[s].Contains(e.x,e.y)>=0?i=t.tiles[s]:t.tiles[s].Selected(!1);t.handleSelection(i)}}),$.subscribe("/PivotViewer/Views/Canvas/Hover",function(e){if(t.isActive&&null==t.selected)for(var i=0;i<t.tiles.length;i++)t.tiles[i].Contains(e.x,e.y)>=0?t.tiles[i].Selected(!0):t.tiles[i].Selected(!1)}),$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(e){if(t.isActive)if(t.dontZoom)t.dontZoom=!1;else{var i=t.Scale,s=(t.currentWidth,t.currentHeight,void 0!=e.scale?0:1e3);void 0!=e.scale?e.scale>=1?t.Scale+=e.scale-1:(t.Scale-=e.scale,t.Scale=t.Scale<1?1:t.Scale):void 0!=e.delta&&(t.Scale=0==e.delta?t.scale:t.Scale+e.delta-1),isNaN(t.Scale)&&(t.Scale=1);var l=(t.width-t.offsetX)*t.Scale,r=(t.height-t.offsetY)*t.Scale;if(l<t.width||1==t.Scale)t.currentOffsetX=t.offsetX,t.currentOffsetY=t.offsetY,t.currentWidth=t.width,t.currentHeight=t.height,t.Scale=1,t.dontZoom=!0,PV.Zoom(0);else{var o=(e.x-t.currentOffsetX)/i*t.Scale,h=(e.y-t.currentOffsetY)/i*t.Scale;t.currentOffsetX=e.x-o,t.currentOffsetY=e.y-h,t.currentWidth=l,t.currentHeight=r}if(t.SetVisibleTilePositions(t.filter,t.currentOffsetX,t.currentOffsetY,!0,s),1==t.Scale&&1!=i){for(var n=0;n<t.tiles.length;n++)t.tiles[n].Selected(!1);t.selected=null,$.publish("/PivotViewer/Views/Item/Selected",[{item:t.selected,bkt:0}])}}}),$.subscribe("/PivotViewer/Views/Canvas/Drag",function(e){if(t.isActive){var i=e.x,s=e.y,l=!1,r=!1;t.currentOffsetX+=i,t.currentOffsetY+=s,i>0&&t.currentOffsetX>t.offsetX&&(t.currentOffsetX-=i,l=!0),s>0&&t.currentOffsetY>t.offsetY&&(t.currentOffsetY-=s,r=!0),t.currentOffsetX<t.offsetX&&t.currentWidth==t.width&&(t.currentOffsetX-=i,l=!0),i<0&&t.currentOffsetX<-1*(t.currentWidth-t.width)&&(t.currentOffsetX-=i,l=!0),t.currentOffsetY<t.offsetY&&t.currentHeight==t.height&&(t.currentOffsetY-=s,r=!0),s<0&&t.currentOffsetY-t.offsetY<-1*(t.currentHeight-t.height)&&(t.currentOffsetY-=s,r=!0),l&&r||(l?t.OffsetTiles(0,s):r?t.OffsetTiles(i,0):t.OffsetTiles(i,s))}})},Setup:function(t,e,i,s,l){this.width=t,this.height=e,this.offsetX=i,this.offsetY=s,this.maxRatio=l,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY},Activate:function(){if(Modernizr.canvas){this._super();var t=this;this.filtered&&this.Filter(this.filterEvt.tiles,this.filterEvt.filter,this.filterEvt.sort,this.filterEvt.stringFacets);for(var e=0;e<this.tiles.length;e++)for(;this.tiles[e]._locations.length>1;)this.tiles[e]._locations.pop();for(l=0;l<this.tiles.length;l++)this.tiles[l].selectedLoc=0;var i=0;if(Debug.Log("this.currentWidth: "+this.currentWidth+" this.width: "+this.width),$(".pv-toolbarpanel-zoomslider").slider("option","value")>0){this.selected=selectedItem="",this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,PV.Zoom(1);for(var s=[],l=0;l<this.tiles.length;l++)this.tiles[l].origwidth=this.TileHeight/TileController._imageController.GetRatio(this.tiles[l].facetItem.Img),this.tiles[l].origheight=this.TileHeight,s.push(this.tiles[l].facetItem.Id);this.SetVisibleTilePositions(s,this.currentOffsetX,this.currentOffsetY,!0,1e3),i=1e3}setTimeout(function(){for(e=0;e<t.tiles.length;e++)t.tiles[e]._locations[0].startx=t.tiles[e]._locations[0].x,t.tiles[e]._locations[0].starty=t.tiles[e]._locations[0].y,t.tiles[e].startwidth=t.tiles[e].width,t.tiles[e].startheight=t.tiles[e].height,t.tiles[e].visible||(t.SetOuterTileDestination(t.width,t.height,t.tiles[e]),t.tiles[e].start=PivotViewer.Utils.Now(),t.tiles[e].end=t.tiles[e].start+1e3);t.maxRatio=TileController._imageController.GetRatio(t.tiles[0].facetItem.Img);for(var e=0;e<t.filter.length;e++){var i=t.filter[e].facetItem,s=TileController._imageController.GetRatio(i.Img);s<t.maxRatio&&(t.maxRatio=s)}var l=t.filter.length==t.tiles.length?0:500;setTimeout(function(){for(var e=0;e<t.tiles.length;e++)t.tiles[e].origwidth=t.tileHeight/TileController._imageController.GetRatio(t.tiles[e].facetItem.Img),t.tiles[e].origheight=t.TileHeight;t.SetVisibleTilePositions(t.filter,t.offsetX,t.offsetY,!1,1e3)},l)},i)}},Filter:function(t,e,i,s){this.sortFacet=i,this.tiles=t,this.filter=e,this.filtered=!1},GetButtonImage:function(){return"images/bucketview.png"},GetButtonImageSelected:function(){return"images/bucketviewselected.png"},GetViewName:function(){return"Graph View"},SetVisibleTilePositions:function(t,e,i,s,l){for(var r=0;r<this.filter.length;r++)s&&(this.filter[r]._locations[0].startx=this.filter[r]._locations[0].x,this.filter[r]._locations[0].starty=this.filter[r]._locations[0].y,this.filter[r].startwidth=this.filter[r].width,this.filter[r].startheight=this.filter[r].height),this.filter[r].start=PivotViewer.Utils.Now(),this.filter[r].end=this.filter[r].start+l},GetSelectedCol:function(t){return selectedCol=Math.round((t._locations[0].x-this.currentOffsetX)/t.width),selectedCol},GetSelectedRow:function(t){return selectedRow=Math.round((t._locations[0].y-this.currentOffsetY)/t.height),selectedRow},CenterOnSelectedTile:function(t){this.SetVisibleTilePositions(this.filter,this.currentOffsetX,this.currentOffsetY,!0,1e3)},handleSelection:function(t){this.selected!=t&&null==this.selected&&0!=$(".pv-toolbarpanel-zoomslider").slider("option","value")&&PV.Zoom(0),null!=t&&(t.Selected(!0),tileHeight=t.height,tileWidth=t.height/TileController._imageController.GetRatio(t.facetItem.Img),tileOrigHeight=t.origheight,tileOrigWidth=t.origwidth,canvasHeight=t.context.canvas.height,canvasWidth=t.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width())),this.selected!=t?(tileHeight/canvasHeight>tileWidth/canvasWidth?origProportion=tileOrigHeight/canvasHeight:origProportion=tileOrigWidth/canvasWidth,null==this.selected&&PV.Zoom(0),this.selected=t,this.CenterOnSelectedTile(t)):(this.selected=t=null,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,PV.Zoom(0)),$.publish("/PivotViewer/Views/Item/Selected",[{item:t,bkt:0}])}});