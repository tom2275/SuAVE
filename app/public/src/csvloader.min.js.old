PivotViewer.Models.Loaders.CSVLoader=PivotViewer.Models.Loaders.ICollectionLoader.subClass({init:function(e,i){this.csvUriNoProxy=e,this.csvUri=i?i+e:e},loadCollection:function(e){this.collection=e,this.collection.config={},this._super(e),e.baseNoProxy=this.csvUriNoProxy,e.base=this.csvUri;var i=e.base,t=i.substring(i.lastIndexOf("/")+1,i.lastIndexOf("."));e.name=t,0==_options.authoring?e.imageBase=t+"/"+t+".dzc":e.imageBase?_options.imageBase=e.imageBase.substr(0,e.imageBase.lastIndexOf("/")+1):(e.imageBase="../img/collection/collection.dzc",_options.imageBase="http://"+window.location.href.split("/")[2]+"/img/collection/"),e.brandImage="";var a=this;this.csvUri.endsWith(".zip")?jBinary.loadData(this.csvUri).then(function(e){var i=new JSZip;i.load(e),a.data=i.file(/.csv/)[0].asText().csvToArray(),a.loadData()}):$.ajax({type:"GET",url:this.csvUri,dataType:"text",success:function(e){if(Debug.log("CSV loaded"),a.data=e.csvToArray(),a.data.length<=1){$(".pv-loading").remove();return $(".pv-wrapper").append('<div id="pv-empty-collection-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>SuAVE</h2><p>There are no items in the CSV Collection<br><br></p></div></div>'),void setTimeout(function(){window.open("#pv-empty-collection-error","_self")},1e3)}a.loadData()},error:function(e,i,t){$(".pv-loading").remove();var a="Error loading CSV Collection<br><br>";a+="URL        : "+this.url+"<br>",a+="Status : "+e.status+" "+t+"<br>",a+="Details    : "+e.responseText+"<br>",a+="<br>SuAVE cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-loading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>SuAVE</h2><p>'+a+"</p></div></div>"),setTimeout(function(){window.open("#pv-loading-error","_self")},1e3)}})},loadData:function(){for(var e=this.data[0],i=0,t=-1,a=-1,o=-1,l=0;l<e.length;l++){if("#"==e[l].charAt(0)){if("#name"==e[l])i=l;else if("#img"==e[l])t=l;else if("#href"==e[l])a=l;else if("#views"==e[l]){var s=1;for(this.collection.config.views=[];null!=this.data[s][l]&&""!=this.data[s][l];)this.collection.config.views.push(this.data[s++][l])}if("#textlocation"!=e[l])continue}var r,n,d=!1,c=!0;if(-1!==(r=e[l].indexOf("#"))){if(-1!==e[l].indexOf("#number",r))n=PivotViewer.Models.FacetType.Number;else if(-1!==e[l].indexOf("#date",r))n=PivotViewer.Models.FacetType.DateTime;else if(-1!==e[l].indexOf("#ordinal",r))n=PivotViewer.Models.FacetType.Ordinal;else if(-1!==e[l].indexOf("#long",r))n=PivotViewer.Models.FacetType.LongString;else if(-1!==e[l].indexOf("#link",r))n=PivotViewer.Models.FacetType.Link,c=!1;else if(-1!==e[l].indexOf("#multi",r))d=!0,n=PivotViewer.Models.FacetType.String;else{if(-1!==e[l].indexOf("#info",r)){o=l,n=PivotViewer.Models.FacetType.Description,c=!1;continue}-1!==e[l].indexOf("#textlocation",r)?(n=PivotViewer.Models.FacetType.Location,r=e[l].indexOf("#textlocation",r)):n=PivotViewer.Models.FacetType.String}-1!==e[l].indexOf("#hidden")&&(c=!1)}else n=PivotViewer.Models.FacetType.String,r=e[l].length;var v=new PivotViewer.Models.Category(e[l].substring(0,r),n,c);v.column=l,v.isMultipleItems=d,this.collection.categories.push(v)}for(l=1;l<this.data.length;l++){var u=this.data[l],f=new PivotViewer.Models.Item(u[t],String(l),-1==a?"":u[a],u[i]);-1!=o&&(f.description=u[o]),this.collection.items.push(f)}$.publish("/PivotViewer/Models/Collection/Loaded",null)},loadColumn:function(e){for(var i=!0,t=0;t<this.collection.items.length;t++){var a=this.collection.items[t],o=this.data[t+1][e.column];if(""!=o.trim()){var l=new PivotViewer.Models.Facet(e.name);if(e.isNumber()||e.isOrdinal()){var s=parseFloat(o.replace(/,/g,"").match(/(?:-?\d+\.?\d*)|(?:-?\d*\.?\d+)/)[0]);l.addValue(new PivotViewer.Models.FacetValue(s,o)),s!=Math.floor(s)&&(i=!1),e.isOrdinal()&&(e.labels[s]=o)}else if(e.isDateTime())l.addValue(new PivotViewer.Models.FacetValue(moment(o,moment.parseFormat(o))._d.toString(),o));else if(e.isString())if(1==e.isMultipleItems)for(var r=o.split("|"),n=0;n<r.length;n++)l.addValue(new PivotViewer.Models.FacetValue(r[n].trim()));else l.addValue(new PivotViewer.Models.FacetValue(o));else if(e.isLink()){var d=new PivotViewer.Models.FacetValue(o,o);d.Href=o,l.addValue(d)}else l.addValue(new PivotViewer.Models.FacetValue(o));a.facets.push(l)}}(e.isNumber()||e.isOrdinal())&&(e.integer=i)},getRow:function(e){for(var i=this.data[e],t=[],a=0;a<Settings.visibleCategories.length;a++){var o=Settings.visibleCategories[a],l=this.collection.categories[o],s=i[l.column];if(""!=s.trim()){var r=new PivotViewer.Models.Facet(l.name);if(l.isString())if(1==l.isMultipleItems){var n=s.split("|");n.length<2&&(n=s.split(","));for(var d=0;d<n.length;d++)r.addValue(new PivotViewer.Models.FacetValue(n[d].trim()))}else r.addValue(new PivotViewer.Models.FacetValue(s));else if(l.isNumber()||l.isOrdinal())r.addValue(new PivotViewer.Models.FacetValue(parseFloat(s.replace(/,/g,"").match(/(?:-?\d+\.?\d*)|(?:-?\d*\.?\d+)/)[0]),s));else if(l.isDateTime())r.addValue(new PivotViewer.Models.FacetValue(moment(s,moment.parseFormat(s))._d.toString(),s));else if(l.isLink()){var c=new PivotViewer.Models.FacetValue(s);c.value=s,c.href=s,r.addValue(c)}else r.addValue(new PivotViewer.Models.FacetValue(s));t.push(r)}}return t}});